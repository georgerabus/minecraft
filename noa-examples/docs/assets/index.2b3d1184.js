import{e as Jn,f as Xt,T as Qt,g as ei,E as $r,R as ti,b as Nr,h as ri,O as ni,i as ii,V as ce,j as ai,S as si,k as oi,F as ui,a as Vr,l as ci,m as nt,D as li,n as hi,o as fi}from"./babylon.39bd9ef3.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&n(s)}).observe(document,{childList:!0,subtree:!0});function r(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerpolicy&&(a.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?a.credentials="include":i.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(i){if(i.ep)return;i.ep=!0;const a=r(i);fetch(i.href,a)}})();window&&!window.global&&(window.global=window.globalThis||{});var Jt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},Ie={exports:{}},qe=typeof Reflect=="object"?Reflect:null,dr=qe&&typeof qe.apply=="function"?qe.apply:function(t,r,n){return Function.prototype.apply.call(t,r,n)},mt;qe&&typeof qe.ownKeys=="function"?mt=qe.ownKeys:Object.getOwnPropertySymbols?mt=function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:mt=function(t){return Object.getOwnPropertyNames(t)};function vi(e){console&&console.warn&&console.warn(e)}var Hr=Number.isNaN||function(t){return t!==t};function z(){z.init.call(this)}Ie.exports=z;Ie.exports.once=gi;z.EventEmitter=z;z.prototype._events=void 0;z.prototype._eventsCount=0;z.prototype._maxListeners=void 0;var pr=10;function Pt(e){if(typeof e!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}Object.defineProperty(z,"defaultMaxListeners",{enumerable:!0,get:function(){return pr},set:function(e){if(typeof e!="number"||e<0||Hr(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");pr=e}});z.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0};z.prototype.setMaxListeners=function(t){if(typeof t!="number"||t<0||Hr(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this};function Gr(e){return e._maxListeners===void 0?z.defaultMaxListeners:e._maxListeners}z.prototype.getMaxListeners=function(){return Gr(this)};z.prototype.emit=function(t){for(var r=[],n=1;n<arguments.length;n++)r.push(arguments[n]);var i=t==="error",a=this._events;if(a!==void 0)i=i&&a.error===void 0;else if(!i)return!1;if(i){var s;if(r.length>0&&(s=r[0]),s instanceof Error)throw s;var o=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw o.context=s,o}var c=a[t];if(c===void 0)return!1;if(typeof c=="function")dr(c,this,r);else for(var u=c.length,h=Zr(c,u),n=0;n<u;++n)dr(h[n],this,r);return!0};function jr(e,t,r,n){var i,a,s;if(Pt(r),a=e._events,a===void 0?(a=e._events=Object.create(null),e._eventsCount=0):(a.newListener!==void 0&&(e.emit("newListener",t,r.listener?r.listener:r),a=e._events),s=a[t]),s===void 0)s=a[t]=r,++e._eventsCount;else if(typeof s=="function"?s=a[t]=n?[r,s]:[s,r]:n?s.unshift(r):s.push(r),i=Gr(e),i>0&&s.length>i&&!s.warned){s.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=e,o.type=t,o.count=s.length,vi(o)}return e}z.prototype.addListener=function(t,r){return jr(this,t,r,!1)};z.prototype.on=z.prototype.addListener;z.prototype.prependListener=function(t,r){return jr(this,t,r,!0)};function di(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function Kr(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=di.bind(n);return i.listener=r,n.wrapFn=i,i}z.prototype.once=function(t,r){return Pt(r),this.on(t,Kr(this,t,r)),this};z.prototype.prependOnceListener=function(t,r){return Pt(r),this.prependListener(t,Kr(this,t,r)),this};z.prototype.removeListener=function(t,r){var n,i,a,s,o;if(Pt(r),i=this._events,i===void 0)return this;if(n=i[t],n===void 0)return this;if(n===r||n.listener===r)--this._eventsCount===0?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,n.listener||r));else if(typeof n!="function"){for(a=-1,s=n.length-1;s>=0;s--)if(n[s]===r||n[s].listener===r){o=n[s].listener,a=s;break}if(a<0)return this;a===0?n.shift():pi(n,a),n.length===1&&(i[t]=n[0]),i.removeListener!==void 0&&this.emit("removeListener",t,o||r)}return this};z.prototype.off=z.prototype.removeListener;z.prototype.removeAllListeners=function(t){var r,n,i;if(n=this._events,n===void 0)return this;if(n.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):n[t]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete n[t]),this;if(arguments.length===0){var a=Object.keys(n),s;for(i=0;i<a.length;++i)s=a[i],s!=="removeListener"&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(r=n[t],typeof r=="function")this.removeListener(t,r);else if(r!==void 0)for(i=r.length-1;i>=0;i--)this.removeListener(t,r[i]);return this};function Yr(e,t,r){var n=e._events;if(n===void 0)return[];var i=n[t];return i===void 0?[]:typeof i=="function"?r?[i.listener||i]:[i]:r?mi(i):Zr(i,i.length)}z.prototype.listeners=function(t){return Yr(this,t,!0)};z.prototype.rawListeners=function(t){return Yr(this,t,!1)};z.listenerCount=function(e,t){return typeof e.listenerCount=="function"?e.listenerCount(t):Wr.call(e,t)};z.prototype.listenerCount=Wr;function Wr(e){var t=this._events;if(t!==void 0){var r=t[e];if(typeof r=="function")return 1;if(r!==void 0)return r.length}return 0}z.prototype.eventNames=function(){return this._eventsCount>0?mt(this._events):[]};function Zr(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}function pi(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function mi(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}function gi(e,t){return new Promise(function(r,n){function i(s){e.removeListener(t,a),n(s)}function a(){typeof e.removeListener=="function"&&e.removeListener("error",i),r([].slice.call(arguments))}Xr(e,t,a,{once:!0}),t!=="error"&&yi(e,i,{once:!0})})}function yi(e,t,r){typeof e.on=="function"&&Xr(e,"error",t,r)}function Xr(e,t,r,n){if(typeof e.on=="function")n.once?e.once(t,r):e.on(t,r);else if(typeof e.addEventListener=="function")e.addEventListener(t,function i(a){n.once&&e.removeEventListener(t,i),r(a)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e)}var Qr=1e-6,Jr=_i;function _i(){var e=new Float32Array(3);return e[0]=0,e[1]=0,e[2]=0,e}var ki=Mi;function Mi(e){var t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}var en=Ci;function Ci(e,t,r){var n=new Float32Array(3);return n[0]=e,n[1]=t,n[2]=r,n}var tn=wi;function wi(e,t){var r=t[0],n=t[1],i=t[2],a=r*r+n*n+i*i;return a>0&&(a=1/Math.sqrt(a),e[0]=t[0]*a,e[1]=t[1]*a,e[2]=t[2]*a),e}var rn=Ti;function Ti(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}var Ei=Li,mr=en,gr=tn,Fi=rn;function Li(e,t){var r=mr(e[0],e[1],e[2]),n=mr(t[0],t[1],t[2]);gr(r,r),gr(n,n);var i=Fi(r,n);return i>1?0:Math.acos(i)}var Pi=bi;function bi(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}var Ai=xi;function xi(e,t,r,n){return e[0]=t,e[1]=r,e[2]=n,e}var Ii=Si,Ot=Qr;function Si(e,t){var r=e[0],n=e[1],i=e[2],a=t[0],s=t[1],o=t[2];return Math.abs(r-a)<=Ot*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(n-s)<=Ot*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-o)<=Ot*Math.max(1,Math.abs(i),Math.abs(o))}var Ri=Oi;function Oi(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}var Di=Bi;function Bi(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}var nn=Ui;function Ui(e,t,r){return e[0]=t[0]-r[0],e[1]=t[1]-r[1],e[2]=t[2]-r[2],e}var an={exports:{}};(function(e){e.exports=nn})(an);var sn=zi;function zi(e,t,r){return e[0]=t[0]*r[0],e[1]=t[1]*r[1],e[2]=t[2]*r[2],e}var on={exports:{}};(function(e){e.exports=sn})(on);var un=qi;function qi(e,t,r){return e[0]=t[0]/r[0],e[1]=t[1]/r[1],e[2]=t[2]/r[2],e}var cn={exports:{}};(function(e){e.exports=un})(cn);var $i=Ni;function Ni(e,t,r){return e[0]=Math.min(t[0],r[0]),e[1]=Math.min(t[1],r[1]),e[2]=Math.min(t[2],r[2]),e}var Vi=Hi;function Hi(e,t,r){return e[0]=Math.max(t[0],r[0]),e[1]=Math.max(t[1],r[1]),e[2]=Math.max(t[2],r[2]),e}var Gi=ji;function ji(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}var Ki=Yi;function Yi(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}var Wi=Zi;function Zi(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e}var Xi=Qi;function Qi(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}var Ji=ea;function ea(e,t,r,n){return e[0]=t[0]+r[0]*n,e[1]=t[1]+r[1]*n,e[2]=t[2]+r[2]*n,e}var ln=ta;function ta(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(r*r+n*n+i*i)}var hn={exports:{}};(function(e){e.exports=ln})(hn);var fn=ra;function ra(e,t){var r=t[0]-e[0],n=t[1]-e[1],i=t[2]-e[2];return r*r+n*n+i*i}var vn={exports:{}};(function(e){e.exports=fn})(vn);var dn=na;function na(e){var t=e[0],r=e[1],n=e[2];return Math.sqrt(t*t+r*r+n*n)}var pn={exports:{}};(function(e){e.exports=dn})(pn);var mn=ia;function ia(e){var t=e[0],r=e[1],n=e[2];return t*t+r*r+n*n}var gn={exports:{}};(function(e){e.exports=mn})(gn);var aa=sa;function sa(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}var oa=ua;function ua(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}var ca=la;function la(e,t,r){var n=t[0],i=t[1],a=t[2],s=r[0],o=r[1],c=r[2];return e[0]=i*c-a*o,e[1]=a*s-n*c,e[2]=n*o-i*s,e}var ha=fa;function fa(e,t,r,n){var i=t[0],a=t[1],s=t[2];return e[0]=i+n*(r[0]-i),e[1]=a+n*(r[1]-a),e[2]=s+n*(r[2]-s),e}var va=da;function da(e,t){t=t||1;var r=Math.random()*2*Math.PI,n=Math.random()*2-1,i=Math.sqrt(1-n*n)*t;return e[0]=Math.cos(r)*i,e[1]=Math.sin(r)*i,e[2]=n*t,e}var pa=ma;function ma(e,t,r){var n=t[0],i=t[1],a=t[2],s=r[3]*n+r[7]*i+r[11]*a+r[15];return s=s||1,e[0]=(r[0]*n+r[4]*i+r[8]*a+r[12])/s,e[1]=(r[1]*n+r[5]*i+r[9]*a+r[13])/s,e[2]=(r[2]*n+r[6]*i+r[10]*a+r[14])/s,e}var ga=ya;function ya(e,t,r){var n=t[0],i=t[1],a=t[2];return e[0]=n*r[0]+i*r[3]+a*r[6],e[1]=n*r[1]+i*r[4]+a*r[7],e[2]=n*r[2]+i*r[5]+a*r[8],e}var _a=ka;function ka(e,t,r){var n=t[0],i=t[1],a=t[2],s=r[0],o=r[1],c=r[2],u=r[3],h=u*n+o*a-c*i,m=u*i+c*n-s*a,p=u*a+s*i-o*n,d=-s*n-o*i-c*a;return e[0]=h*u+d*-s+m*-c-p*-o,e[1]=m*u+d*-o+p*-s-h*-c,e[2]=p*u+d*-c+h*-o-m*-s,e}var Ma=Ca;function Ca(e,t,r,n){var i=r[1],a=r[2],s=t[1]-i,o=t[2]-a,c=Math.sin(n),u=Math.cos(n);return e[0]=t[0],e[1]=i+s*u-o*c,e[2]=a+s*c+o*u,e}var wa=Ta;function Ta(e,t,r,n){var i=r[0],a=r[2],s=t[0]-i,o=t[2]-a,c=Math.sin(n),u=Math.cos(n);return e[0]=i+o*c+s*u,e[1]=t[1],e[2]=a+o*u-s*c,e}var Ea=Fa;function Fa(e,t,r,n){var i=r[0],a=r[1],s=t[0]-i,o=t[1]-a,c=Math.sin(n),u=Math.cos(n);return e[0]=i+s*u-o*c,e[1]=a+s*c+o*u,e[2]=t[2],e}var La=Pa,Me=Jr();function Pa(e,t,r,n,i,a){var s,o;for(t||(t=3),r||(r=0),n?o=Math.min(n*t+r,e.length):o=e.length,s=r;s<o;s+=t)Me[0]=e[s],Me[1]=e[s+1],Me[2]=e[s+2],i(Me,Me,a),e[s]=Me[0],e[s+1]=Me[1],e[s+2]=Me[2];return e}var T={EPSILON:Qr,create:Jr,clone:ki,angle:Ei,fromValues:en,copy:Pi,set:Ai,equals:Ii,exactEquals:Ri,add:Di,subtract:nn,sub:an.exports,multiply:sn,mul:on.exports,divide:un,div:cn.exports,min:$i,max:Vi,floor:Gi,ceil:Ki,round:Wi,scale:Xi,scaleAndAdd:Ji,distance:ln,dist:hn.exports,squaredDistance:fn,sqrDist:vn.exports,length:dn,len:pn.exports,squaredLength:mn,sqrLen:gn.exports,negate:aa,inverse:oa,normalize:tn,dot:rn,cross:ca,lerp:ha,random:va,transformMat4:pa,transformMat3:ga,transformQuat:_a,rotateX:Ma,rotateY:wa,rotateZ:Ea,forEach:La};function ba(e){for(var t=new Array(e),r=0;r<e;++r)t[r]=r;return t}var Aa=ba;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var xa=function(e){return e!=null&&(yn(e)||Ia(e)||!!e._isBuffer)};function yn(e){return!!e.constructor&&typeof e.constructor.isBuffer=="function"&&e.constructor.isBuffer(e)}function Ia(e){return typeof e.readFloatLE=="function"&&typeof e.slice=="function"&&yn(e.slice(0,0))}var Sa=Aa,Ra=xa,Oa=typeof Float64Array<"u";function Da(e,t){return e[0]-t[0]}function Ba(){var e=this.stride,t=new Array(e.length),r;for(r=0;r<t.length;++r)t[r]=[Math.abs(e[r]),r];t.sort(Da);var n=new Array(t.length);for(r=0;r<n.length;++r)n[r]=t[r][1];return n}function Ua(e,t){var r=["View",t,"d",e].join("");t<0&&(r="View_Nil"+e);var n=e==="generic";if(t===-1){var i="function "+r+"(a){this.data=a;};var proto="+r+".prototype;proto.dtype='"+e+"';proto.index=function(){return -1};proto.size=0;proto.dimension=-1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function(){return new "+r+"(this.data);};proto.get=proto.set=function(){};proto.pick=function(){return null};return function construct_"+r+"(a){return new "+r+"(a);}",v=new Function(i);return v()}else if(t===0){var i="function "+r+"(a,d) {this.data = a;this.offset = d};var proto="+r+".prototype;proto.dtype='"+e+"';proto.index=function(){return this.offset};proto.dimension=0;proto.size=1;proto.shape=proto.stride=proto.order=[];proto.lo=proto.hi=proto.transpose=proto.step=function "+r+"_copy() {return new "+r+"(this.data,this.offset)};proto.pick=function "+r+"_pick(){return TrivialArray(this.data);};proto.valueOf=proto.get=function "+r+"_get(){return "+(n?"this.data.get(this.offset)":"this.data[this.offset]")+"};proto.set=function "+r+"_set(v){return "+(n?"this.data.set(this.offset,v)":"this.data[this.offset]=v")+"};return function construct_"+r+"(a,b,c,d){return new "+r+"(a,d)}",v=new Function("TrivialArray",i);return v(Ct[e][0])}var i=["'use strict'"],a=Sa(t),s=a.map(function(f){return"i"+f}),o="this.offset+"+a.map(function(f){return"this.stride["+f+"]*i"+f}).join("+"),c=a.map(function(f){return"b"+f}).join(","),u=a.map(function(f){return"c"+f}).join(",");i.push("function "+r+"(a,"+c+","+u+",d){this.data=a","this.shape=["+c+"]","this.stride=["+u+"]","this.offset=d|0}","var proto="+r+".prototype","proto.dtype='"+e+"'","proto.dimension="+t),i.push("Object.defineProperty(proto,'size',{get:function "+r+"_size(){return "+a.map(function(f){return"this.shape["+f+"]"}).join("*"),"}})"),t===1?i.push("proto.order=[0]"):(i.push("Object.defineProperty(proto,'order',{get:"),t<4?(i.push("function "+r+"_order(){"),t===2?i.push("return (Math.abs(this.stride[0])>Math.abs(this.stride[1]))?[1,0]:[0,1]}})"):t===3&&i.push("var s0=Math.abs(this.stride[0]),s1=Math.abs(this.stride[1]),s2=Math.abs(this.stride[2]);if(s0>s1){if(s1>s2){return [2,1,0];}else if(s0>s2){return [1,2,0];}else{return [1,0,2];}}else if(s0>s2){return [2,0,1];}else if(s2>s1){return [0,1,2];}else{return [0,2,1];}}})")):i.push("ORDER})")),i.push("proto.set=function "+r+"_set("+s.join(",")+",v){"),n?i.push("return this.data.set("+o+",v)}"):i.push("return this.data["+o+"]=v}"),i.push("proto.get=function "+r+"_get("+s.join(",")+"){"),n?i.push("return this.data.get("+o+")}"):i.push("return this.data["+o+"]}"),i.push("proto.index=function "+r+"_index(",s.join(),"){return "+o+"}"),i.push("proto.hi=function "+r+"_hi("+s.join(",")+"){return new "+r+"(this.data,"+a.map(function(f){return["(typeof i",f,"!=='number'||i",f,"<0)?this.shape[",f,"]:i",f,"|0"].join("")}).join(",")+","+a.map(function(f){return"this.stride["+f+"]"}).join(",")+",this.offset)}");var h=a.map(function(f){return"a"+f+"=this.shape["+f+"]"}),m=a.map(function(f){return"c"+f+"=this.stride["+f+"]"});i.push("proto.lo=function "+r+"_lo("+s.join(",")+"){var b=this.offset,d=0,"+h.join(",")+","+m.join(","));for(var p=0;p<t;++p)i.push("if(typeof i"+p+"==='number'&&i"+p+">=0){d=i"+p+"|0;b+=c"+p+"*d;a"+p+"-=d}");i.push("return new "+r+"(this.data,"+a.map(function(f){return"a"+f}).join(",")+","+a.map(function(f){return"c"+f}).join(",")+",b)}"),i.push("proto.step=function "+r+"_step("+s.join(",")+"){var "+a.map(function(f){return"a"+f+"=this.shape["+f+"]"}).join(",")+","+a.map(function(f){return"b"+f+"=this.stride["+f+"]"}).join(",")+",c=this.offset,d=0,ceil=Math.ceil");for(var p=0;p<t;++p)i.push("if(typeof i"+p+"==='number'){d=i"+p+"|0;if(d<0){c+=b"+p+"*(a"+p+"-1);a"+p+"=ceil(-a"+p+"/d)}else{a"+p+"=ceil(a"+p+"/d)}b"+p+"*=d}");i.push("return new "+r+"(this.data,"+a.map(function(f){return"a"+f}).join(",")+","+a.map(function(f){return"b"+f}).join(",")+",c)}");for(var d=new Array(t),l=new Array(t),p=0;p<t;++p)d[p]="a[i"+p+"]",l[p]="b[i"+p+"]";i.push("proto.transpose=function "+r+"_transpose("+s+"){"+s.map(function(f,y){return f+"=("+f+"===undefined?"+y+":"+f+"|0)"}).join(";"),"var a=this.shape,b=this.stride;return new "+r+"(this.data,"+d.join(",")+","+l.join(",")+",this.offset)}"),i.push("proto.pick=function "+r+"_pick("+s+"){var a=[],b=[],c=this.offset");for(var p=0;p<t;++p)i.push("if(typeof i"+p+"==='number'&&i"+p+">=0){c=(c+this.stride["+p+"]*i"+p+")|0}else{a.push(this.shape["+p+"]);b.push(this.stride["+p+"])}");i.push("var ctor=CTOR_LIST[a.length+1];return ctor(this.data,a,b,c)}"),i.push("return function construct_"+r+"(data,shape,stride,offset){return new "+r+"(data,"+a.map(function(f){return"shape["+f+"]"}).join(",")+","+a.map(function(f){return"stride["+f+"]"}).join(",")+",offset)}");var v=new Function("CTOR_LIST","ORDER",i.join(`
`));return v(Ct[e],Ba)}function za(e){if(Ra(e))return"buffer";if(Oa)switch(Object.prototype.toString.call(e)){case"[object Float64Array]":return"float64";case"[object Float32Array]":return"float32";case"[object Int8Array]":return"int8";case"[object Int16Array]":return"int16";case"[object Int32Array]":return"int32";case"[object Uint8Array]":return"uint8";case"[object Uint16Array]":return"uint16";case"[object Uint32Array]":return"uint32";case"[object Uint8ClampedArray]":return"uint8_clamped";case"[object BigInt64Array]":return"bigint64";case"[object BigUint64Array]":return"biguint64"}return Array.isArray(e)?"array":"generic"}var Ct={float32:[],float64:[],int8:[],int16:[],int32:[],uint8:[],uint16:[],uint32:[],array:[],uint8_clamped:[],bigint64:[],biguint64:[],buffer:[],generic:[]};function qa(e,t,r,n){if(e===void 0){var u=Ct.array[0];return u([])}else typeof e=="number"&&(e=[e]);t===void 0&&(t=[e.length]);var i=t.length;if(r===void 0){r=new Array(i);for(var a=i-1,s=1;a>=0;--a)r[a]=s,s*=t[a]}if(n===void 0){n=0;for(var a=0;a<i;++a)r[a]<0&&(n-=(t[a]-1)*r[a])}for(var o=za(e),c=Ct[o];c.length<=i+1;)c.push(Ua(o,c.length-1));var u=c[i+1];return u(e,t,r,n)}var at=qa;function $a(e,t,r,n,i,a,s,o,c,u){for(var h=0,m=Math.floor,p=m(t)|0,d=m(r)|0,l=m(n)|0,v=i>0?1:-1,f=a>0?1:-1,y=s>0?1:-1,g=Math.abs(1/i),k=Math.abs(1/a),_=Math.abs(1/s),M=v>0?p+1-t:t-p,C=f>0?d+1-r:r-d,P=y>0?l+1-n:n-l,E=g<1/0?g*M:1/0,L=k<1/0?k*C:1/0,w=_<1/0?_*P:1/0,F=-1;h<=o;){var x=e(p,d,l);if(x)return c&&(c[0]=t+h*i,c[1]=r+h*a,c[2]=n+h*s),u&&(u[0]=u[1]=u[2]=0,F===0&&(u[0]=-v),F===1&&(u[1]=-f),F===2&&(u[2]=-y)),x;E<L?E<w?(p+=v,h=E,E+=g,F=0):(l+=y,h=w,w+=_,F=2):L<w?(d+=f,h=L,L+=k,F=1):(l+=y,h=w,w+=_,F=2)}return c&&(c[0]=t+h*i,c[1]=r+h*a,c[2]=n+h*s),u&&(u[0]=u[1]=u[2]=0),0}function Na(e,t,r,n,i,a){var s=+t[0],o=+t[1],c=+t[2],u=+r[0],h=+r[1],m=+r[2],p=Math.sqrt(u*u+h*h+m*m);if(p===0)throw new Error("Can't raycast along a zero vector");return u/=p,h/=p,m/=p,typeof n>"u"?n=64:n=+n,$a(e,s,o,c,u,h,m,n,i,a)}var Va=Na;const Ha="game-inputs",Ga="0.8.0",ja="Simple library to abstract key/mouse events for games.",Ka="src/inputs.js",Ya="dist/src/inputs.d.ts",Wa=["/src","/dist"],Za={start:"cd docs/ && webpack serve",build:"tsc; cd docs/ && webpack"},Xa="Andy Hall",Qa="ISC",Ja=["game","inputs","key","mouse","events"],es={events:"^3.3.0"},ts={type:"git",url:"https://github.com/fenomas/game-inputs"},rs={url:"https://github.com/fenomas/game-inputs/issues"},ns={name:Ha,version:Ga,description:ja,main:Ka,typings:Ya,files:Wa,scripts:Za,author:Xa,license:Qa,keywords:Ja,dependencies:es,repository:ts,bugs:rs};var is=ns.version;function as(){this.preventDefaults=!1,this.stopPropagation=!1,this.allowContextMenu=!1,this.disabled=!1}class ss{constructor(t,r){this.version=is;var n=Object.assign({},new as,r||{});this.element=t||document,this.preventDefaults=!!n.preventDefaults,this.stopPropagation=!!n.stopPropagation,this.allowContextMenu=!!n.allowContextMenu,this.disabled=!!n.disabled,this.filterEvents=(i,a)=>!0,this.down=new Ie.exports.EventEmitter,this.up=new Ie.exports.EventEmitter,this.state={},this.pointerState={dx:0,dy:0,scrollx:0,scrolly:0,scrollz:0},this.pressCount={},this.releaseCount={},this._keyBindmap={},this._keyStates={},this._bindPressCount={},this._touches={lastX:0,lastY:0,currID:null},this._pressedDuringMeta={},document.readyState!=="loading"?yr(this):document.addEventListener("DOMContentLoaded",i=>{yr(this)},{once:!0})}bind(t,...r){r.forEach(n=>{var i=this._keyBindmap[n]||[];i.includes(t)||(i.push(t),this._keyBindmap[n]=i)}),this.state[t]=!!this.state[t],this.pressCount[t]=this.pressCount[t]||0,this.releaseCount[t]=this.releaseCount[t]||0}unbind(t){for(var r in this._keyBindmap){var n=this._keyBindmap[r],i=n.indexOf(t);i>-1&&n.splice(i,1)}}getBindings(){var t={};for(var r in this._keyBindmap){var n=this._keyBindmap[r];n.forEach(i=>{t[i]=t[i]||[],t[i].push(r)})}return t}tick(){Dt(this.pointerState),Dt(this.pressCount),Dt(this.releaseCount)}}function Dt(e){for(var t in e)e[t]=0}function yr(e){window.addEventListener("keydown",_r.bind(null,e,!0),!1),window.addEventListener("keyup",_r.bind(null,e,!1),!1);var t={passive:!0};window.PointerEvent?(e.element.addEventListener("pointerdown",ct.bind(null,e,!0),t),window.document.addEventListener("pointerup",ct.bind(null,e,!1),t),e.element.addEventListener("pointermove",kr.bind(null,e),t)):(e.element.addEventListener("mousedown",ct.bind(null,e,!0),t),window.document.addEventListener("mouseup",ct.bind(null,e,!1),t),e.element.addEventListener("mousemove",kr.bind(null,e),t)),e.element.addEventListener("wheel",os.bind(null,e),t),e.element.addEventListener("contextmenu",us.bind(null,e),!1),window.addEventListener("blur",cs.bind(null,e),!1)}function _r(e,t,r){bt(r.code,t,e,r),hs(t,e,r)}function ct(e,t,r){if("pointerId"in r)if(t){if(e._touches.currID!==null)return;e._touches.currID=r.pointerId}else{if(e._touches.currID!==r.pointerId)return;e._touches.currID=null}var n="button"in r?r.button+1:1;return bt("Mouse"+n,t,e,r),!1}function kr(e,t){if(!("pointerId"in t&&e._touches.currID!==null&&e._touches.currID!==t.pointerId)){var r=t.movementX||t.mozMovementX||0,n=t.movementY||t.mozMovementY||0;e.pointerState.dx+=r,e.pointerState.dy+=n}}function os(e,t){var r=1;switch(t.deltaMode){case 0:r=1;break;case 1:r=12;break;case 2:r=e.element.clientHeight||window.innerHeight;break}e.pointerState.scrollx+=(t.deltaX||0)*r,e.pointerState.scrolly+=(t.deltaY||0)*r,e.pointerState.scrollz+=(t.deltaZ||0)*r}function us(e,t){if(!e.allowContextMenu)return t.preventDefault(),!1}function cs(e){for(var t in e._keyStates)!e._keyStates[t]||/^Mouse\d/.test(t)||bt(t,!1,e,{code:t,note:"This is a mocked KeyboardEvent made by the 'game-inputs' module",preventDefault:()=>{},stopPropagation:()=>{}})}function bt(e,t,r,n){var i=r._keyBindmap[e];if(!!i){var a=r._keyStates[e];_n(a,t)&&(r._keyStates[e]=t,i.forEach(s=>{var o=r.filterEvents?r.filterEvents(n,s):!0;!o||ls(s,t,r,n)})),"button"in n||(r.preventDefaults&&!n.defaultPrevented&&n.preventDefault(),r.stopPropagation&&n.stopPropagation())}}function ls(e,t,r,n){var i=t?r.pressCount:r.releaseCount;i[e]=(i[e]||0)+1;var a=r._bindPressCount[e]||0;a+=t?1:-1,a<0&&(a=0),r._bindPressCount[e]=a;var s=r.state[e];if(_n(s,a)){r.state[e]=a>0;var o=t?r.down:r.up;r.disabled||o.emit(e,n)}}function _n(e,t){return e?!t:t}function hs(e,t,r){var n=/^Meta/.test(r.code);if(r.metaKey&&!n&&e)t._pressedDuringMeta[r.code]=!0;else if(n&&!e){for(var i in t._pressedDuringMeta)!t._keyStates[i]||/^Mouse\d/.test(i)||bt(i,!1,t,{code:i,note:"This is a mocked KeyboardEvent made by the 'game-inputs' module",preventDefault:()=>{},stopPropagation:()=>{}});t._pressedDuringMeta={}}}var fs={preventDefaults:!1,stopPropagation:!1,allowContextMenu:!1},vs={forward:["KeyW","ArrowUp"],backward:["KeyS","ArrowDown"],left:["KeyA","ArrowLeft"],right:["KeyD","ArrowRight"],fire:"Mouse1","mid-fire":["Mouse2","KeyQ"],"alt-fire":["Mouse3","KeyE"],jump:"Space"};class ds extends ss{constructor(t,r,n){r=Object.assign({},fs,r),super(n,r);var i=r.bindings||vs;for(var a in i){var s=Array.isArray(i[a])?i[a]:[i[a]];this.bind(a,...s)}}}class ps{constructor(t=null,r=10){this.stickyPointerLock=!1,this.stickyFullscreen=!1,this.tickRate=30,this.maxRenderRate=0,this.maxTickTime=100,this.pointerLock=!1,this.fullscreen=!1,this.onTick=function(n){},this.onRender=function(n,i,a){},this.onInit=function(){},this.onResize=function(){},this.onPointerLockChanged=function(n=!1){},this.onFullscreenChanged=function(n=!1){},this.onPointerLockError=function(n){},this._data=new ms(r),Ms(()=>{gs(this),_s(this,t),this.onInit()})}}function ms(e=10){this.nowObject=performance||Date,this.pollTime=e,this.renderAccum=0,this.lastTickStarted=0,this.lastFrameStarted=0,this.lastRenderStarted=0,this.avgTickTime=2,this.frameCB=null,this.intervalCB=null,this.intervalID=-1}function gs(e){var t=e._data,r=t.nowObject.now();t.lastTickStarted=r,t.lastFrameStarted=r,t.lastRenderStarted=r,t.frameCB=()=>ys(e),t.intervalCB=()=>er(e),requestAnimationFrame(t.frameCB),t.pollTime>0&&(t.intervalID=setInterval(t.intervalCB,t.pollTime))}function ys(e){var t=e._data;requestAnimationFrame(t.frameCB),er(e);var r=t.nowObject.now(),n=r-t.lastFrameStarted;if(t.lastFrameStarted=r,e.maxRenderRate>0){t.renderAccum+=n;var i=1e3/e.maxRenderRate;if(t.renderAccum<i)return;t.renderAccum-=i,t.renderAccum>i&&(t.renderAccum=i)}var a=r-t.lastRenderStarted;t.lastRenderStarted=r;var s=1e3/e.tickRate,o=(r-t.lastTickStarted)/s;o<0&&(o=0),e.onRender(a,o,s),setTimeout(er,0,e,!0)}function er(e,t=!1){var r=e._data,n=r.nowObject.now(),i=n;t&&(i+=r.avgTickTime);var a=n+e.maxTickTime;a>n||(a=n+1);for(var s=1e3/e.tickRate;r.lastTickStarted+s<i;){e.onTick(s),r.lastTickStarted+=s;var o=r.nowObject.now();if(r.avgTickTime=ks(r.avgTickTime,o-n),n=o,n>a){r.lastTickStarted=n;return}}}function _s(e,t){if(!!t){var r=!1,n=!1,i=c=>{if(r=t===document.pointerLockElement,!!c!==r)if(c){var u=t.requestPointerLock();u&&u.catch&&u.catch(h=>{})}else document.exitPointerLock()},a=c=>{n=t===document.fullscreenElement,!!c!==n&&(c?t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullscreen&&t.webkitRequestFullscreen():document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen())};document.addEventListener("pointerlockchange",c=>{r=t===document.pointerLockElement,e.onPointerLockChanged(r)}),document.addEventListener("fullscreenchange",c=>{n=t===document.fullscreenElement,e.onFullscreenChanged(n)}),document.addEventListener("pointerlockerror",c=>{r=t===document.pointerLockElement,e.onPointerLockError(c)}),Object.defineProperty(e,"pointerLock",{get:()=>r,set:i}),Object.defineProperty(e,"fullscreen",{get:()=>n,set:a}),t.addEventListener("click",c=>{e.stickyPointerLock&&i(!0),e.stickyFullscreen&&a(!0)});var s=()=>e.onResize();if(window.ResizeObserver){var o=new ResizeObserver(s);o.observe(t)}else window.addEventListener("resize",s)}}function ks(e,t){return t>e*4&&(t=e*4),t<e*.25&&(t=e*.25),.9*e+.1*t}function Ms(e){if(document.readyState==="loading"){var t=()=>{document.removeEventListener("readystatechange",t),e()};document.addEventListener("readystatechange",t)}else setTimeout(e,0)}class Cs extends Ie.exports.EventEmitter{constructor(t,r){super(),r=r||{},this.noa=t;var n=r.domElement||null;typeof n=="string"&&(n=document.querySelector(n)),this.element=n||ws(),this.canvas=Ts(this.element),Fs(t,this.canvas),this.supportsPointerLock=!1,this.pointerInGame=!1,this.isFocused=!!document.hasFocus(),this.hasPointerLock=!1;var i=10;this._shell=new ps(this.element,i),this._shell.tickRate=r.tickRate,this._shell.maxRenderRate=r.maxRenderRate,this._shell.stickyPointerLock=r.stickyPointerLock,this._shell.stickyFullscreen=r.stickyFullscreen,this._shell.maxTickTime=50,this._shell.onTick=t.tick.bind(t),this._shell.onRender=t.render.bind(t),this._shell.onPointerLockChanged=a=>{this.hasPointerLock=a,this.emit(a?"gainedPointerLock":"lostPointerLock"),a&&(this.pointerInGame=!0)},this._shell.onInit=()=>{this._shell.onResize=t.rendering.resize.bind(t.rendering),Es(this),this.element.addEventListener("mouseenter",()=>{this.pointerInGame=!0}),this.element.addEventListener("mouseleave",()=>{this.pointerInGame=!1}),window.addEventListener("focus",()=>{this.isFocused=!0}),window.addEventListener("blur",()=>{this.isFocused=!1});var a=()=>{this.pointerInGame=!0,this.isFocused=!0,this.element.removeEventListener("mousedown",a)};this.element.addEventListener("mousedown",a),this.emit("DOMready"),this._shell.onInit=null}}appendTo(t){this.element.appendChild(t)}setPointerLock(t=!1){this._shell.pointerLock=!!t}}function ws(){var e=document.createElement("div");return e.tabIndex=1,e.style.position="fixed",e.style.left="0px",e.style.right="0px",e.style.top="0px",e.style.bottom="0px",e.style.height="100%",e.style.overflow="hidden",document.body.appendChild(e),document.body.style.overflow="hidden",document.body.style.height="100%",e.id="noa-container",e}function Ts(e){var t=e.querySelector("canvas");return t||(t=document.createElement("canvas"),t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.height="100%",t.style.width="100%",t.id="noa-canvas",e.insertBefore(t,e.firstChild)),t}function Es(e){var t="pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document;if(t){e.supportsPointerLock=!0;var r=function(n){e.supportsPointerLock=!1,document.removeEventListener(n.type,r)};document.addEventListener("touchmove",r)}}function Fs(e,t){var r=0,n=()=>{var i=t.width;t.width=i+1,t.width=i,r++>10&&e.off("beforeRender",n)};e.on("beforeRender",n)}var At=He,j=T;function He(e,t){if(!(this instanceof He))return new He(e,t);var r=j.create();j.add(r,e,t),this.base=j.min(j.create(),e,r),this.vec=j.clone(t),this.max=j.max(j.create(),e,r),this.mag=j.length(this.vec)}var Ls=He,Q=Ls.prototype;Q.width=function(){return this.vec[0]};Q.height=function(){return this.vec[1]};Q.depth=function(){return this.vec[2]};Q.x0=function(){return this.base[0]};Q.y0=function(){return this.base[1]};Q.z0=function(){return this.base[2]};Q.x1=function(){return this.max[0]};Q.y1=function(){return this.max[1]};Q.z1=function(){return this.max[2]};Q.translate=function(e){return j.add(this.max,this.max,e),j.add(this.base,this.base,e),this};Q.setPosition=function(e){return j.add(this.max,e,this.vec),j.copy(this.base,e),this};Q.expand=function(e){var t=j.create(),r=j.create();return j.max(t,e.max,this.max),j.min(r,e.base,this.base),j.subtract(t,t,r),new He(r,t)};Q.intersects=function(e){return!(e.base[0]>this.max[0]||e.base[1]>this.max[1]||e.base[2]>this.max[2]||e.max[0]<this.base[0]||e.max[1]<this.base[1]||e.max[2]<this.base[2])};Q.touches=function(e){var t=this.union(e);return t!==null&&(t.width()==0||t.height()==0||t.depth()==0)};Q.union=function(e){if(!this.intersects(e))return null;var t=Math.max(e.base[0],this.base[0]),r=Math.max(e.base[1],this.base[1]),n=Math.max(e.base[2],this.base[2]),i=Math.min(e.max[0],this.max[0]),a=Math.min(e.max[1],this.max[1]),s=Math.min(e.max[2],this.max[2]);return new He([t,r,n],[i-t,a-r,s-n])};var Ps=[],bs=[],As=[],xs=[],Is=[],Ss=[],Rs=[],Os=[],Ds=[],Bs=[],Us=[],zs=[];function qs(e,t,r,n,i,a){var s=Ps,o=bs,c=As,u=xs,h=Is,m=Ss,p=Os,d=Math.floor,l=0,v=0,f=0,y=0,g=0;if(_(),f===0)return 0;for(y=P();v<=f;){if(M(y)){var k=C();if(k)return l}y=P()}for(l+=f,g=0;g<3;g++)n[g]+=r[g],i[g]+=r[g];return l;function _(){if(v=0,f=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),f!==0)for(var w=0;w<3;w++){var F=r[w]>=0;u[w]=F?1:-1;var x=F?i[w]:n[w];s[w]=F?n[w]:i[w],o[w]=E(x,u[w]),c[w]=L(s[w],u[w]),p[w]=r[w]/f,h[w]=Math.abs(1/p[w]);var S=F?o[w]+1-x:x-o[w];m[w]=h[w]<1/0?h[w]*S:1/0}}function M(w){for(var F=u[0],x=w===0?o[0]:c[0],S=o[0]+F,b=u[1],A=w===1?o[1]:c[1],U=o[1]+b,D=u[2],R=w===2?o[2]:c[2],I=o[2]+D,$=x;$!=S;$+=F)for(var V=A;V!=U;V+=b)for(var G=R;G!=I;G+=D)if(e($,V,G))return!0;return!1}function C(){l+=v;var w=u[y],F=v/f,x=Us;for(g=0;g<3;g++){var S=r[g]*F;n[g]+=S,i[g]+=S,x[g]=r[g]-S}w>0?i[y]=Math.round(i[y]):n[y]=Math.round(n[y]);var b=t(l,y,w,x);if(b)return!0;for(g=0;g<3;g++)r[g]=x[g];return _(),f===0}function P(){var w=m[0]<m[1]?m[0]<m[2]?0:2:m[1]<m[2]?1:2,F=m[w]-v;for(v=m[w],o[w]+=u[w],m[w]+=h[w],g=0;g<3;g++)s[g]+=F*p[g],c[g]=L(s[g],u[g]);return w}function E(w,F){return d(w-F*a)}function L(w,F){return d(w+F*a)}}function $s(e,t,r,n,i,a){for(var s=Rs,o=Ds,c=Bs,u=zs,h=0;h<3;h++)s[h]=+r[h],c[h]=+t.max[h],o[h]=+t.base[h];a||(a=1e-10);var m=qs(e,n,s,o,c,a);if(!i){for(h=0;h<3;h++)u[h]=r[h]>0?c[h]-t.max[h]:o[h]-t.base[h];t.translate(u)}return m}var st=$s;function Ns(){this.inverseX=!1,this.inverseY=!1,this.sensitivityMult=1,this.sensitivityMultOutsidePointerlock=0,this.sensitivityX=10,this.sensitivityY=10,this.initialZoom=0,this.zoomSpeed=.2}var Bt=[T.create(),T.create(),T.create()],Vs=T.create();class Hs{constructor(t,r){r=Object.assign({},new Ns,r),this.noa=t,this.sensitivityX=+r.sensitivityX,this.sensitivityY=+r.sensitivityY,this.inverseX=!!r.inverseX,this.inverseY=!!r.inverseY,this.sensitivityMult=r.sensitivityMult,this.sensitivityMultOutsidePointerlock=r.sensitivityMultOutsidePointerlock,this.heading=0,this.pitch=0,this.cameraTarget=this.noa.ents.createEntity(["position"]);var n=.9*t.ents.getPositionData(t.playerEntity).height;t.ents.addComponent(this.cameraTarget,"followsEntity",{entity:t.playerEntity,offset:[0,n,0]}),this.zoomDistance=r.initialZoom,this.zoomSpeed=r.zoomSpeed,this.currentZoom=r.initialZoom,this._dirVector=T.fromValues(0,0,1)}_localGetTargetPosition(){var t=this.noa.ents.getPositionData(this.cameraTarget),r=Bt[0];return T.copy(r,t._renderPosition)}_localGetPosition(){var t=this._localGetTargetPosition();return this.currentZoom===0?t:T.scaleAndAdd(t,t,this._dirVector,-this.currentZoom)}getTargetPosition(){var t=this._localGetTargetPosition(),r=Bt[1];return this.noa.localToGlobal(t,r)}getPosition(){var t=this._localGetPosition(),r=Bt[2];return this.noa.localToGlobal(t,r)}getDirection(){return this._dirVector}applyInputsToCamera(){var t=this.sensitivityMult;if(this.noa.container.supportsPointerLock&&(this.noa.container.hasPointerLock||(t*=this.sensitivityMultOutsidePointerlock)),t!==0){var r=this.noa.inputs.pointerState;js(r);var n=.0066*Math.PI/180,i=r.dx*this.sensitivityX*t*n,a=r.dy*this.sensitivityY*t*n;this.inverseX&&(i=-i),this.inverseY&&(a=-a);var s=2*Math.PI;this.heading+=i<0?i+s:i,this.heading>s&&(this.heading-=s);var o=Math.PI/2-.001;this.pitch=Math.max(-o,Math.min(o,this.pitch+a)),T.set(this._dirVector,0,0,1);var c=this._dirVector,u=Vs;T.rotateX(c,c,u,this.pitch),T.rotateY(c,c,u,this.heading)}}updateBeforeEntityRenderSystems(){this.currentZoom+=(this.zoomDistance-this.currentZoom)*this.zoomSpeed}updateAfterEntityRenderSystems(){var t=Gs(this);this.currentZoom>t&&(this.currentZoom=t)}}function Gs(e){e._sweepBox||(e._sweepBox=new At([0,0,0],[.2,.2,.2]),e._sweepGetVoxel=e.noa.world.getBlockSolidity.bind(e.noa.world),e._sweepVec=T.create(),e._sweepHit=()=>!0);var t=T.copy(e._sweepVec,e._localGetTargetPosition());T.add(t,t,e.noa.worldOriginOffset);for(var r=0;r<3;r++)t[r]-=.1;e._sweepBox.setPosition(t);var n=Math.max(e.zoomDistance,e.currentZoom)+.1;return T.scale(e._sweepVec,e.getDirection(),-n),st(e._sweepGetVoxel,e._sweepBox,e._sweepVec,e._sweepHit,!0)}function js(e){var t=e.dx,r=e.dy,n=Math.abs(t)>400&&Math.abs(t/Ze)>4,i=Math.abs(r)>400&&Math.abs(r/Xe)>4;n||i?(e.dx=Ze,e.dy=Xe,Ze=(Ze+t)/2,Xe=(Xe+r)/2):(Ze=t||1,Xe=r||1)}var Ze=0,Xe=0,Ks=class{constructor(){this.list=[],this.hash={},this._map={},this._pendingRemovals=[]}add(t,r){if(typeof this._map[t]=="number"){var n=this._map[t];this.hash[t]=r,this.list[n]=r}else this._map[t]=this.list.length,this.hash[t]=r,this.list.push(r)}remove(t){var r=this._map[t];this.hash[t]=null,this.list[r]=null,this._pendingRemovals.push(t)}dispose(){this.list=null,this.hash=null,this._map=null,this._pendingRemovals.length=0}flush(){for(var t=0;t<this._pendingRemovals.length;t++){var r=this._pendingRemovals[t];this.hash[r]===null&&Ys(this,r)}this._pendingRemovals.length=0}};function Ys(e,t){var r=e._map[t];if(delete e.hash[t],delete e._map[t],r===e.list.length-1)e.list.pop();else{var n=e.list.pop();if(e.list[r]=n,n===null||n[0]===null){var i=e.list.length;for(var a in e._map)if(e._map[a]===i){e._map[a]=r;return}}else{var s=n.__id||n[0].__id;e._map[s]=r}}}var Ws=Xs,Zs=Ks;/*!
 * ent-comp: a light, *fast* Entity Component System in JS
 * @url      github.com/fenomas/ent-comp
 * @author   Andy Hall <andy@fenomas.com>
 * @license  MIT
*/function Xs(){var e=this;this.components={},this.comps=this.components;var t=this.components,r=1,n={},i=[],a=[],s={timeout:!1,removals:[],multiComps:[]};this._storage=n,this._systems=i,this._renderSystems=a,this.createEntity=function(l){var v=r++;return Array.isArray(l)&&l.forEach(f=>e.addComponent(v,f)),v},this.deleteEntity=function(l){return Object.keys(n).forEach(v=>{var f=n[v];f.hash[l]&&o(l,v)}),e},this.createComponent=function(l){if(!l)throw new Error("Missing component definition");var v=l.name;if(!v)throw new Error("Component definition must have a name property.");if(typeof v!="string")throw new Error("Component name must be a string.");if(v==="")throw new Error("Component name must be a non-empty string.");if(n[v])throw new Error(`Component ${v} already exists.`);var f={};return f.name=v,f.multi=!!l.multi,f.order=isNaN(l.order)?99:l.order,f.state=l.state||{},f.onAdd=l.onAdd||null,f.onRemove=l.onRemove||null,f.system=l.system||null,f.renderSystem=l.renderSystem||null,t[v]=f,n[v]=new Zs,n[v]._pendingMultiCleanup=!1,n[v]._multiCleanupIDs=f.multi?[]:null,f.system&&(i.push(v),i.sort((y,g)=>t[y].order-t[g].order)),f.renderSystem&&(a.push(v),a.sort((y,g)=>t[y].order-t[g].order)),v},this.overwriteComponent=function(l,v){var f=t[l];if(!f)throw new Error(`Unknown component: ${l}`);if(!v)throw new Error("Missing component definition");if(f.name!==v.name)throw new Error("Overwriting component must use the same name property.");var y={};y.name=l,y.multi=!!v.multi,y.order=isNaN(v.order)?99:v.order,y.state=v.state||{},y.onAdd=v.onAdd||null,y.onRemove=v.onRemove||null,y.system=v.system||null,y.renderSystem=v.renderSystem||null,t[l]=y,n[l]._pendingMultiCleanup=!1,n[l]._multiCleanupIDs=y.multi?[]:null;var g=i.indexOf(l);y.system&&g<0&&i.push(l),!y.system&&g>=0&&i.splice(g,1),i.sort((M,C)=>t[M].order-t[C].order);var k=a.indexOf(l);y.renderSystem&&k<0&&a.push(l),!y.renderSystem&&k>=0&&a.splice(k,1),a.sort((M,C)=>t[M].order-t[C].order);var _=y.state;return this.getStatesList(l).forEach(M=>{for(var C in _)C in M||(M[C]=_[C]);y.onAdd&&y.onAdd(M.__id,M)}),l},this.deleteComponent=function(l){var v=n[l];if(!v)throw new Error(`Unknown component: ${l}`);v.flush(),v.list.forEach(g=>{if(!!g){var k=g.__id||g[0].__id;o(k,l)}});var f=i.indexOf(l),y=a.indexOf(l);return f>-1&&i.splice(f,1),y>-1&&a.splice(y,1),n[l].dispose(),delete n[l],delete t[l],e},this.addComponent=function(l,v,f){var y=t[v],g=n[v];if(!g)throw new Error(`Unknown component: ${v}.`);if(g.hash[l]&&!y.multi)throw new Error(`Entity ${l} already has component: ${v}.`);var k=Object.assign({},{__id:l},y.state,f);if(k.__id=l,y.multi){var _=g.hash[l];_||(_=[],g.add(l,_)),_.push(k)}else g.add(l,k);return y.onAdd&&y.onAdd(l,k),this},this.hasComponent=function(l,v){var f=n[v];if(!f)throw new Error(`Unknown component: ${v}.`);return!!f.hash[l]},this.removeComponent=function(l,v){var f=n[v];if(!f)throw new Error(`Unknown component: ${v}.`);return o(l,v),e},this.getState=function(l,v){var f=n[v];if(!f)throw new Error(`Unknown component: ${v}.`);return f.hash[l]},this.getStatesList=function(l){var v=n[l];if(!v)throw new Error(`Unknown component: ${l}.`);return m(),v.list},this.getStateAccessor=function(l){if(!n[l])throw new Error(`Unknown component: ${l}.`);var v=n[l].hash;return f=>v[f]},this.getComponentAccessor=function(l){if(!n[l])throw new Error(`Unknown component: ${l}.`);var v=n[l].hash;return f=>!!v[f]},this.tick=function(l){m();for(var v=0;v<i.length;v++){var f=i[v],y=t[f],g=n[f];y.system(l,g.list),m()}return e},this.render=function(l){m();for(var v=0;v<a.length;v++){var f=a[v],y=t[f],g=n[f];y.renderSystem(l,g.list),m()}return e},this.removeMultiComponent=function(l,v,f){var y=t[v],g=n[v];if(!g)throw new Error(`Unknown component: ${v}.`);if(!y.multi)throw new Error("removeMultiComponent called on non-multi component");return c(l,y,g,f),e};function o(l,v){var f=t[v],y=n[v],g=y.hash[l];!g||(y.remove(l),f.onRemove&&(f.multi?(g.forEach(k=>{k&&f.onRemove(l,k)}),g.length=0):f.onRemove(l,g)),s.removals.push(y),u())}function c(l,v,f,y){var g=f.hash[l];if(!!g){var k=g[y];!k||(g[y]=null,v.onRemove&&v.onRemove(l,k),s.multiComps.push({entID:l,data:f}),u())}}function u(){s.timeout||(s.timeout=!0,setTimeout(h,1))}function h(){s.timeout=!1,m()}function m(){s.multiComps.length&&p(s.multiComps),s.removals.length&&d(s.removals)}function p(l){for(var v=0;v<l.length;v++){var{entID:f,data:y}=l[v],g=y.hash[f];if(!!g){for(var k=0;k<g.length;k++)g[k]||(g.splice(k,1),k--);g.length===0&&(y.remove(f),s.removals.push(y))}}l.length=0}function d(l){for(var v=0;v<l.length;v++){var f=l[v];f.flush()}l.length=0}}class Qs{constructor(){this.position=null,this.width=.8,this.height=.8,this._localPosition=null,this._renderPosition=null,this._extents=null}}function Js(e){return{name:"position",order:60,state:new Qs,onAdd:function(t,r){var n=[0,0,0];r.position&&T.copy(n,r.position),r.position=n,r._localPosition=T.create(),r._renderPosition=T.create(),r._extents=new Float32Array(6),e.globalToLocal(r.position,null,r._localPosition),T.copy(r._renderPosition,r._localPosition),tr(r)},onRemove:null,system:function(t,r){for(var n=e.worldOriginOffset,i=0;i<r.length;i++){var a=r[i];T.add(a.position,a._localPosition,n),tr(a)}}}}function tr(e){var t=e.width/2,r=e._localPosition,n=e._extents;n[0]=r[0]-t,n[1]=r[1],n[2]=r[2]-t,n[3]=r[0]+t,n[4]=r[1]+e.height,n[5]=r[2]+t}class eo{constructor(){this.body=null}}function to(e){return{name:"physics",order:40,state:new eo,onAdd:function(t,r){r.body=e.physics.addBody();var n=e.ents.getPositionData(r.__id);kn(r,n)},onRemove:function(t,r){if(e.ents.hasPosition(r.__id)){var n=e.ents.getPositionData(r.__id);Mr(r,n),Cr(r,n,0,!1)}e.physics.removeBody(r.body)},system:function(t,r){for(var n=0;n<r.length;n++){var i=r[n],a=e.ents.getPositionData(i.__id);Mr(i,a)}},renderSystem:function(t,r){var n=e.positionInCurrentTick,i=1e3/e.container._shell.tickRate;i*=e.timeScale;for(var a=n*i,s=(a-i)/1e3,o=0;o<r.length;o++){var c=r[o],u=c.__id,h=e.ents.getPositionData(u),m=e.ents.cameraSmoothed(u);Cr(c,h,s,m)}}}}var lt=T.create();function kn(e,t){var r=e.body.aabb,n=t._extents;T.copy(r.base,n),T.set(r.vec,t.width,t.height,t.width),T.add(r.max,r.base,r.vec)}function Mr(e,t){var r=e.body.aabb.base,n=t.width/2;T.set(t._localPosition,r[0]+n,r[1],r[2]+n)}function Cr(e,t,r,n){var i=e.body.velocity;T.scaleAndAdd(lt,t._localPosition,i,r),n&&T.lerp(lt,t._renderPosition,lt,.3),T.copy(t._renderPosition,lt)}var B={},q={},ir=32;q.INT_BITS=ir;q.INT_MAX=2147483647;q.INT_MIN=-1<<ir-1;q.sign=function(e){return(e>0)-(e<0)};q.abs=function(e){var t=e>>ir-1;return(e^t)-t};q.min=function(e,t){return t^(e^t)&-(e<t)};q.max=function(e,t){return e^(e^t)&-(e<t)};q.isPow2=function(e){return!(e&e-1)&&!!e};q.log2=function(e){var t,r;return t=(e>65535)<<4,e>>>=t,r=(e>255)<<3,e>>>=r,t|=r,r=(e>15)<<2,e>>>=r,t|=r,r=(e>3)<<1,e>>>=r,t|=r,t|e>>1};q.log10=function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0};q.popCount=function(e){return e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),(e+(e>>>4)&252645135)*16843009>>>24};function Mn(e){var t=32;return e&=-e,e&&t--,e&65535&&(t-=16),e&16711935&&(t-=8),e&252645135&&(t-=4),e&858993459&&(t-=2),e&1431655765&&(t-=1),t}q.countTrailingZeros=Mn;q.nextPow2=function(e){return e+=e===0,--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e+1};q.prevPow2=function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,e|=e>>>16,e-(e>>>1)};q.parity=function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,e&=15,27030>>>e&1};var et=new Array(256);(function(e){for(var t=0;t<256;++t){var r=t,n=t,i=7;for(r>>>=1;r;r>>>=1)n<<=1,n|=r&1,--i;e[t]=n<<i&255}})(et);q.reverse=function(e){return et[e&255]<<24|et[e>>>8&255]<<16|et[e>>>16&255]<<8|et[e>>>24&255]};q.interleave2=function(e,t){return e&=65535,e=(e|e<<8)&16711935,e=(e|e<<4)&252645135,e=(e|e<<2)&858993459,e=(e|e<<1)&1431655765,t&=65535,t=(t|t<<8)&16711935,t=(t|t<<4)&252645135,t=(t|t<<2)&858993459,t=(t|t<<1)&1431655765,e|t<<1};q.deinterleave2=function(e,t){return e=e>>>t&1431655765,e=(e|e>>>1)&858993459,e=(e|e>>>2)&252645135,e=(e|e>>>4)&16711935,e=(e|e>>>16)&65535,e<<16>>16};q.interleave3=function(e,t,r){return e&=1023,e=(e|e<<16)&4278190335,e=(e|e<<8)&251719695,e=(e|e<<4)&3272356035,e=(e|e<<2)&1227133513,t&=1023,t=(t|t<<16)&4278190335,t=(t|t<<8)&251719695,t=(t|t<<4)&3272356035,t=(t|t<<2)&1227133513,e|=t<<1,r&=1023,r=(r|r<<16)&4278190335,r=(r|r<<8)&251719695,r=(r|r<<4)&3272356035,r=(r|r<<2)&1227133513,e|r<<2};q.deinterleave3=function(e,t){return e=e>>>t&1227133513,e=(e|e>>>2)&3272356035,e=(e|e>>>4)&251719695,e=(e|e>>>8)&4278190335,e=(e|e>>>16)&1023,e<<22>>22};q.nextCombination=function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>Mn(e)+1};function Cn(e,t,r){var n=e[r]|0;if(n<=0)return[];var i=new Array(n),a;if(r===e.length-1)for(a=0;a<n;++a)i[a]=t;else for(a=0;a<n;++a)i[a]=Cn(e,t,r+1);return i}function ro(e,t){var r,n;for(r=new Array(e),n=0;n<e;++n)r[n]=t;return r}function no(e,t){switch(typeof t>"u"&&(t=0),typeof e){case"number":if(e>0)return ro(e|0,t);break;case"object":if(typeof e.length=="number")return Cn(e,t,0);break}return[]}var io=no;/*!
 * Determine if an object is a Buffer
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */var ao=function(t){return t!=null&&t.constructor!=null&&typeof t.constructor.isBuffer=="function"&&t.constructor.isBuffer(t)},Ge=q,ee=io,so=ao;Jt.__TYPEDARRAY_POOL||(Jt.__TYPEDARRAY_POOL={UINT8:ee([32,0]),UINT16:ee([32,0]),UINT32:ee([32,0]),INT8:ee([32,0]),INT16:ee([32,0]),INT32:ee([32,0]),FLOAT:ee([32,0]),DOUBLE:ee([32,0]),DATA:ee([32,0]),UINT8C:ee([32,0]),BUFFER:ee([32,0])});var oo=typeof Uint8ClampedArray<"u",Z=Jt.__TYPEDARRAY_POOL;Z.UINT8C||(Z.UINT8C=ee([32,0]));Z.BUFFER||(Z.BUFFER=ee([32,0]));var xt=Z.DATA,ar=Z.BUFFER;B.free=function(t){if(so(t))ar[Ge.log2(t.length)].push(t);else{if(Object.prototype.toString.call(t)!=="[object ArrayBuffer]"&&(t=t.buffer),!t)return;var r=t.length||t.byteLength,n=Ge.log2(r)|0;xt[n].push(t)}};function wn(e){if(!!e){var t=e.length||e.byteLength,r=Ge.log2(t);xt[r].push(e)}}function uo(e){wn(e.buffer)}B.freeUint8=B.freeUint16=B.freeUint32=B.freeInt8=B.freeInt16=B.freeInt32=B.freeFloat32=B.freeFloat=B.freeFloat64=B.freeDouble=B.freeUint8Clamped=B.freeDataView=uo;B.freeArrayBuffer=wn;B.freeBuffer=function(t){ar[Ge.log2(t.length)].push(t)};B.malloc=function(t,r){if(r===void 0||r==="arraybuffer")return re(t);switch(r){case"uint8":return sr(t);case"uint16":return Tn(t);case"uint32":return En(t);case"int8":return Fn(t);case"int16":return Ln(t);case"int32":return Pn(t);case"float":case"float32":return bn(t);case"double":case"float64":return An(t);case"uint8_clamped":return xn(t);case"buffer":throw"Buffer not supported";case"data":case"dataview":return In(t);default:return null}return null};function re(t){var t=Ge.nextPow2(t),r=Ge.log2(t),n=xt[r];return n.length>0?n.pop():new ArrayBuffer(t)}B.mallocArrayBuffer=re;function sr(e){return new Uint8Array(re(e),0,e)}B.mallocUint8=sr;function Tn(e){return new Uint16Array(re(2*e),0,e)}B.mallocUint16=Tn;function En(e){return new Uint32Array(re(4*e),0,e)}B.mallocUint32=En;function Fn(e){return new Int8Array(re(e),0,e)}B.mallocInt8=Fn;function Ln(e){return new Int16Array(re(2*e),0,e)}B.mallocInt16=Ln;function Pn(e){return new Int32Array(re(4*e),0,e)}B.mallocInt32=Pn;function bn(e){return new Float32Array(re(4*e),0,e)}B.mallocFloat32=B.mallocFloat=bn;function An(e){return new Float64Array(re(8*e),0,e)}B.mallocFloat64=B.mallocDouble=An;function xn(e){return oo?new Uint8ClampedArray(re(e),0,e):sr(e)}B.mallocUint8Clamped=xn;function In(e){return new DataView(re(e),0,e)}B.mallocDataView=In;B.clearCache=function(){for(var t=0;t<32;++t)Z.UINT8[t].length=0,Z.UINT16[t].length=0,Z.UINT32[t].length=0,Z.INT8[t].length=0,Z.INT16[t].length=0,Z.INT32[t].length=0,Z.FLOAT[t].length=0,Z.DOUBLE[t].length=0,Z.UINT8C[t].length=0,xt[t].length=0,ar[t].length=0};var co=lo,gt=32;function lo(e,t){t<=4*gt?yt(0,t-1,e):_t(0,t-1,e)}function yt(e,t,r){for(var n=2*(e+1),i=e+1;i<=t;++i){for(var a=r[n++],s=r[n++],o=i,c=n-2;o-- >e;){var u=r[c-2],h=r[c-1];if(u<a)break;if(u===a&&h<s)break;r[c]=u,r[c+1]=h,c-=2}r[c]=a,r[c+1]=s}}function wr(e,t,r){e*=2,t*=2;var n=r[e],i=r[e+1];r[e]=r[t],r[e+1]=r[t+1],r[t]=n,r[t+1]=i}function Tr(e,t,r){e*=2,t*=2,r[e]=r[t],r[e+1]=r[t+1]}function ho(e,t,r,n){e*=2,t*=2,r*=2;var i=n[e],a=n[e+1];n[e]=n[t],n[e+1]=n[t+1],n[t]=n[r],n[t+1]=n[r+1],n[r]=i,n[r+1]=a}function Er(e,t,r,n,i){e*=2,t*=2,i[e]=i[t],i[t]=r,i[e+1]=i[t+1],i[t+1]=n}function pe(e,t,r){e*=2,t*=2;var n=r[e],i=r[t];return n<i?!1:n===i?r[e+1]>r[t+1]:!0}function ht(e,t,r,n){e*=2;var i=n[e];return i<t?!0:i===t?n[e+1]<r:!1}function _t(e,t,r){var n=(t-e+1)/6|0,i=e+n,a=t-n,s=e+t>>1,o=s-n,c=s+n,u=i,h=o,m=s,p=c,d=a,l=e+1,v=t-1,f=0;pe(u,h,r)&&(f=u,u=h,h=f),pe(p,d,r)&&(f=p,p=d,d=f),pe(u,m,r)&&(f=u,u=m,m=f),pe(h,m,r)&&(f=h,h=m,m=f),pe(u,p,r)&&(f=u,u=p,p=f),pe(m,p,r)&&(f=m,m=p,p=f),pe(h,d,r)&&(f=h,h=d,d=f),pe(h,m,r)&&(f=h,h=m,m=f),pe(p,d,r)&&(f=p,p=d,d=f);for(var y=r[2*h],g=r[2*h+1],k=r[2*p],_=r[2*p+1],M=2*u,C=2*m,P=2*d,E=2*i,L=2*s,w=2*a,F=0;F<2;++F){var x=r[M+F],S=r[C+F],b=r[P+F];r[E+F]=x,r[L+F]=S,r[w+F]=b}Tr(o,e,r),Tr(c,t,r);for(var A=l;A<=v;++A)if(ht(A,y,g,r))A!==l&&wr(A,l,r),++l;else if(!ht(A,k,_,r))for(;;)if(ht(v,k,_,r)){ht(v,y,g,r)?(ho(A,l,v,r),++l,--v):(wr(A,v,r),--v);break}else{if(--v<A)break;continue}Er(e,l-1,y,g,r),Er(t,v+1,k,_,r),l-2-e<=gt?yt(e,l-2,r):_t(e,l-2,r),t-(v+2)<=gt?yt(v+2,t,r):_t(v+2,t,r),v-l<=gt?yt(l,v,r):_t(l,v,r)}var Sn={init:vo,sweepBipartite:po,sweepComplete:mo,scanBipartite:go,scanComplete:yo},N=B,fo=q,It=co,te=1<<28,Se=1024,K=N.mallocInt32(Se),ye=N.mallocInt32(Se),_e=N.mallocInt32(Se),Ae=N.mallocInt32(Se),$e=N.mallocInt32(Se),it=N.mallocInt32(Se),O=N.mallocDouble(Se*8);function vo(e){var t=fo.nextPow2(e);K.length<t&&(N.free(K),K=N.mallocInt32(t)),ye.length<t&&(N.free(ye),ye=N.mallocInt32(t)),_e.length<t&&(N.free(_e),_e=N.mallocInt32(t)),Ae.length<t&&(N.free(Ae),Ae=N.mallocInt32(t)),$e.length<t&&(N.free($e),$e=N.mallocInt32(t)),it.length<t&&(N.free(it),it=N.mallocInt32(t));var r=8*t;O.length<r&&(N.free(O),O=N.mallocDouble(r))}function Ne(e,t,r,n){var i=t[n],a=e[r-1];e[i]=a,t[a]=i}function Ve(e,t,r,n){e[r]=n,t[n]=r}function po(e,t,r,n,i,a,s,o,c,u){for(var h=0,m=2*e,p=e-1,d=m-1,l=r;l<n;++l){var v=a[l],f=m*l;O[h++]=i[f+p],O[h++]=-(v+1),O[h++]=i[f+d],O[h++]=v}for(var l=s;l<o;++l){var v=u[l]+te,y=m*l;O[h++]=c[y+p],O[h++]=-v,O[h++]=c[y+d],O[h++]=v}var g=h>>>1;It(O,g);for(var k=0,_=0,l=0;l<g;++l){var M=O[2*l+1]|0;if(M>=te)M=M-te|0,Ne(_e,Ae,_--,M);else if(M>=0)Ne(K,ye,k--,M);else if(M<=-te){M=-M-te|0;for(var C=0;C<k;++C){var P=t(K[C],M);if(P!==void 0)return P}Ve(_e,Ae,_++,M)}else{M=-M-1|0;for(var C=0;C<_;++C){var P=t(M,_e[C]);if(P!==void 0)return P}Ve(K,ye,k++,M)}}}function mo(e,t,r,n,i,a,s,o,c,u){for(var h=0,m=2*e,p=e-1,d=m-1,l=r;l<n;++l){var v=a[l]+1<<1,f=m*l;O[h++]=i[f+p],O[h++]=-v,O[h++]=i[f+d],O[h++]=v}for(var l=s;l<o;++l){var v=u[l]+1<<1,y=m*l;O[h++]=c[y+p],O[h++]=-v|1,O[h++]=c[y+d],O[h++]=v|1}var g=h>>>1;It(O,g);for(var k=0,_=0,M=0,l=0;l<g;++l){var C=O[2*l+1]|0,P=C&1;if(l<g-1&&C>>1===O[2*l+3]>>1&&(P=2,l+=1),C<0){for(var E=-(C>>1)-1,L=0;L<M;++L){var w=t($e[L],E);if(w!==void 0)return w}if(P!==0)for(var L=0;L<k;++L){var w=t(K[L],E);if(w!==void 0)return w}if(P!==1)for(var L=0;L<_;++L){var w=t(_e[L],E);if(w!==void 0)return w}P===0?Ve(K,ye,k++,E):P===1?Ve(_e,Ae,_++,E):P===2&&Ve($e,it,M++,E)}else{var E=(C>>1)-1;P===0?Ne(K,ye,k--,E):P===1?Ne(_e,Ae,_--,E):P===2&&Ne($e,it,M--,E)}}}function go(e,t,r,n,i,a,s,o,c,u,h,m){var p=0,d=2*e,l=t,v=t+e,f=1,y=1;n?y=te:f=te;for(var g=i;g<a;++g){var k=g+f,_=d*g;O[p++]=s[_+l],O[p++]=-k,O[p++]=s[_+v],O[p++]=k}for(var g=c;g<u;++g){var k=g+y,M=d*g;O[p++]=h[M+l],O[p++]=-k}var C=p>>>1;It(O,C);for(var P=0,g=0;g<C;++g){var E=O[2*g+1]|0;if(E<0){var k=-E,L=!1;if(k>=te?(L=!n,k-=te):(L=!!n,k-=1),L)Ve(K,ye,P++,k);else{var w=m[k],F=d*k,x=h[F+t+1],S=h[F+t+1+e];e:for(var b=0;b<P;++b){var A=K[b],U=d*A;if(!(S<s[U+t+1]||s[U+t+1+e]<x)){for(var D=t+2;D<e;++D)if(h[F+D+e]<s[U+D]||s[U+D+e]<h[F+D])continue e;var R=o[A],I;if(n?I=r(w,R):I=r(R,w),I!==void 0)return I}}}}else Ne(K,ye,P--,E-f)}}function yo(e,t,r,n,i,a,s,o,c,u,h){for(var m=0,p=2*e,d=t,l=t+e,v=n;v<i;++v){var f=v+te,y=p*v;O[m++]=a[y+d],O[m++]=-f,O[m++]=a[y+l],O[m++]=f}for(var v=o;v<c;++v){var f=v+1,g=p*v;O[m++]=u[g+d],O[m++]=-f}var k=m>>>1;It(O,k);for(var _=0,v=0;v<k;++v){var M=O[2*v+1]|0;if(M<0){var f=-M;if(f>=te)K[_++]=f-te;else{f-=1;var C=h[f],P=p*f,E=u[P+t+1],L=u[P+t+1+e];e:for(var w=0;w<_;++w){var F=K[w],x=s[F];if(x===C)break;var S=p*F;if(!(L<a[S+t+1]||a[S+t+1+e]<E)){for(var b=t+2;b<e;++b)if(u[P+b+e]<a[S+b]||a[S+b+e]<u[P+b])continue e;var A=r(x,C);if(A!==void 0)return A}}}}else{for(var f=M-te,w=_-1;w>=0;--w)if(K[w]===f){for(var b=w+1;b<_;++b)K[b-1]=K[b];break}--_}}}var or={},be="d",Ue="ax",Rn="vv",Ut="fp",Qe="es",wt="rs",ur="re",tt="rb",On="ri",De="rp",Tt="bs",cr="be",rt="bb",Dn="bi",Be="bp",zt="rv",qt="Q",rr=[be,Ue,Rn,wt,ur,tt,On,Tt,cr,rt,Dn];function _o(e,t,r){var n="bruteForce"+(e?"Red":"Blue")+(t?"Flip":"")+(r?"Full":""),i=["function ",n,"(",rr.join(),"){","var ",Qe,"=2*",be,";"],a="for(var i="+wt+","+De+"="+Qe+"*"+wt+";i<"+ur+";++i,"+De+"+="+Qe+"){var x0="+tt+"["+Ue+"+"+De+"],x1="+tt+"["+Ue+"+"+De+"+"+be+"],xi="+On+"[i];",s="for(var j="+Tt+","+Be+"="+Qe+"*"+Tt+";j<"+cr+";++j,"+Be+"+="+Qe+"){var y0="+rt+"["+Ue+"+"+Be+"],"+(r?"y1="+rt+"["+Ue+"+"+Be+"+"+be+"],":"")+"yi="+Dn+"[j];";return e?i.push(a,qt,":",s):i.push(s,qt,":",a),r?i.push("if(y1<x0||x1<y0)continue;"):t?i.push("if(y0<=x0||x1<y0)continue;"):i.push("if(y0<x0||x1<y0)continue;"),i.push("for(var k="+Ue+"+1;k<"+be+";++k){var r0="+tt+"[k+"+De+"],r1="+tt+"[k+"+be+"+"+De+"],b0="+rt+"[k+"+Be+"],b1="+rt+"[k+"+be+"+"+Be+"];if(r1<b0||b1<r0)continue "+qt+";}var "+zt+"="+Rn+"("),t?i.push("yi,xi"):i.push("xi,yi"),i.push(");if("+zt+"!==void 0)return "+zt+";}}}"),{name:n,code:i.join("")}}function Bn(e){var t="bruteForce"+(e?"Full":"Partial"),r=[],n=rr.slice();e||n.splice(3,0,Ut);var i=["function "+t+"("+n.join()+"){"];function a(c,u){var h=_o(c,u,e);r.push(h.code),i.push("return "+h.name+"("+rr.join()+");")}i.push("if("+ur+"-"+wt+">"+cr+"-"+Tt+"){"),e?(a(!0,!1),i.push("}else{"),a(!1,!1)):(i.push("if("+Ut+"){"),a(!0,!0),i.push("}else{"),a(!0,!1),i.push("}}else{if("+Ut+"){"),a(!1,!0),i.push("}else{"),a(!1,!1),i.push("}")),i.push("}}return "+t);var s=r.join("")+i.join(""),o=new Function(s);return o()}or.partial=Bn(!1);or.full=Bn(!0);var Un=Mo,ko="for(var j=2*a,k=j*c,l=k,m=c,n=b,o=a+b,p=c;d>p;++p,k+=j){var _;if($)if(m===p)m+=1,l+=j;else{for(var s=0;j>s;++s){var t=e[k+s];e[k+s]=e[l],e[l++]=t}var u=f[p];f[p]=f[m],f[m++]=u}}return m";function Mo(e,t){var r="abcdef".split("").concat(t),n=[];return e.indexOf("lo")>=0&&n.push("lo=e[k+n]"),e.indexOf("hi")>=0&&n.push("hi=e[k+o]"),r.push(ko.replace("_",n.join()).replace("$",e)),Function.apply(void 0,r)}var Co=Fo,wo=Un,Fr=wo("lo<p0",["p0"]),To=8;function Eo(e,t,r,n,i,a){for(var s=2*e,o=s*(r+1)+t,c=r+1;c<n;++c,o+=s)for(var u=i[o],h=c,m=s*(c-1);h>r&&i[m+t]>u;--h,m-=s){for(var p=m,d=m+s,l=0;l<s;++l,++p,++d){var v=i[p];i[p]=i[d],i[d]=v}var f=a[h];a[h]=a[h-1],a[h-1]=f}}function Fo(e,t,r,n,i,a){if(n<=r+1)return r;for(var s=r,o=n,c=n+r>>>1,u=2*e,h=c,m=i[u*c+t];s<o;){if(o-s<To){Eo(e,t,s,o,i,a),m=i[u*c+t];break}var p=o-s,d=Math.random()*p+s|0,l=i[u*d+t],v=Math.random()*p+s|0,f=i[u*v+t],y=Math.random()*p+s|0,g=i[u*y+t];l<=f?g>=f?(h=v,m=f):l>=g?(h=d,m=l):(h=y,m=g):f>=g?(h=v,m=f):g>=l?(h=d,m=l):(h=y,m=g);for(var M=u*(o-1),C=u*h,k=0;k<u;++k,++M,++C){var _=i[M];i[M]=i[C],i[C]=_}var P=a[o-1];a[o-1]=a[h],a[h]=P,h=Fr(e,t,s,o-1,i,a,m);for(var M=u*(o-1),C=u*h,k=0;k<u;++k,++M,++C){var _=i[M];i[M]=i[C],i[C]=_}var P=a[o-1];if(a[o-1]=a[h],a[h]=P,c<h){for(o=h-1;s<o&&i[u*(o-1)+t]===m;)o-=1;o+=1}else if(h<c)for(s=h+1;s<o&&i[u*s+t]===m;)s+=1;else break}return Fr(e,t,r,c,i,a,i[u*c+t])}var Lo=qo,ze=B,$t=q,zn=or,Po=zn.partial,bo=zn.full,Ce=Sn,Ao=Co,Ke=Un,Lr=128,xo=1<<22,Io=1<<22,So=Ke("!(lo>=p0)&&!(p1>=hi)",["p0","p1"]),Pr=Ke("lo===p0",["p0"]),Ro=Ke("lo<p0",["p0"]),Oo=Ke("hi<=p0",["p0"]),br=Ke("lo<=p0&&p0<=hi",["p0"]),Do=Ke("lo<p0&&p0<=hi",["p0"]),lr=6,hr=2,qn=1024,X=ze.mallocInt32(qn),xe=ze.mallocDouble(qn);function Bo(e,t){var r=8*$t.log2(t+1)*(e+1)|0,n=$t.nextPow2(lr*r);X.length<n&&(ze.free(X),X=ze.mallocInt32(n));var i=$t.nextPow2(hr*r);xe.length<i&&(ze.free(xe),xe=ze.mallocDouble(i))}function ae(e,t,r,n,i,a,s,o,c){var u=lr*e;X[u]=t,X[u+1]=r,X[u+2]=n,X[u+3]=i,X[u+4]=a,X[u+5]=s;var h=hr*e;xe[h]=o,xe[h+1]=c}function Uo(e,t,r,n,i,a,s,o,c,u,h){var m=2*e,p=c*m,d=u[p+t];e:for(var l=i,v=i*m;l<a;++l,v+=m){var f=s[v+t],y=s[v+t+e];if(!(d<f||y<d)&&!(n&&d===f)){for(var g=o[l],k=t+1;k<e;++k){var f=s[v+k],y=s[v+k+e],_=u[p+k],M=u[p+k+e];if(y<_||M<f)continue e}var C;if(n?C=r(h,g):C=r(g,h),C!==void 0)return C}}}function zo(e,t,r,n,i,a,s,o,c,u){var h=2*e,m=o*h,p=c[m+t];e:for(var d=n,l=n*h;d<i;++d,l+=h){var v=s[d];if(v!==u){var f=a[l+t],y=a[l+t+e];if(!(p<f||y<p)){for(var g=t+1;g<e;++g){var f=a[l+g],y=a[l+g+e],k=c[m+g],_=c[m+g+e];if(y<k||_<f)continue e}var M=r(v,u);if(M!==void 0)return M}}}}function qo(e,t,r,n,i,a,s,o,c){Bo(e,n+s);var u=0,h=2*e,m;for(ae(u++,0,0,n,0,s,r?16:0,-1/0,1/0),r||ae(u++,0,0,s,0,n,1,-1/0,1/0);u>0;){u-=1;var p=u*lr,d=X[p],l=X[p+1],v=X[p+2],f=X[p+3],y=X[p+4],g=X[p+5],k=u*hr,_=xe[k],M=xe[k+1],C=g&1,P=!!(g&16),E=i,L=a,w=o,F=c;if(C&&(E=o,L=c,w=i,F=a),!(g&2&&(v=Ro(e,d,l,v,E,L,M),l>=v))&&!(g&4&&(l=Oo(e,d,l,v,E,L,_),l>=v))){var x=v-l,S=y-f;if(P){if(e*x*(x+S)<Io){if(m=Ce.scanComplete(e,d,t,l,v,E,L,f,y,w,F),m!==void 0)return m;continue}}else if(e*Math.min(x,S)<Lr){if(m=Po(e,d,t,C,l,v,E,L,f,y,w,F),m!==void 0)return m;continue}else if(e*x*S<xo){if(m=Ce.scanBipartite(e,d,t,C,l,v,E,L,f,y,w,F),m!==void 0)return m;continue}var b=So(e,d,l,v,E,L,_,M);if(l<b)if(e*(b-l)<Lr){if(m=bo(e,d+1,t,l,b,E,L,f,y,w,F),m!==void 0)return m}else if(d===e-2){if(C?m=Ce.sweepBipartite(e,t,f,y,w,F,l,b,E,L):m=Ce.sweepBipartite(e,t,l,b,E,L,f,y,w,F),m!==void 0)return m}else ae(u++,d+1,l,b,f,y,C,-1/0,1/0),ae(u++,d+1,f,y,l,b,C^1,-1/0,1/0);if(b<v){var A=Ao(e,d,f,y,w,F),U=w[h*A+d],D=Pr(e,d,A,y,w,F,U);if(D<y&&ae(u++,d,b,v,D,y,(C|4)+(P?16:0),U,M),f<A&&ae(u++,d,b,v,f,A,(C|2)+(P?16:0),_,U),A+1===D){if(P?m=zo(e,d,t,b,v,E,L,A,w,F[A]):m=Uo(e,d,t,C,b,v,E,L,A,w,F[A]),m!==void 0)return m}else if(A<D){var R;if(P){if(R=br(e,d,b,v,E,L,U),b<R){var I=Pr(e,d,b,R,E,L,U);if(d===e-2){if(b<I&&(m=Ce.sweepComplete(e,t,b,I,E,L,A,D,w,F),m!==void 0)||I<R&&(m=Ce.sweepBipartite(e,t,I,R,E,L,A,D,w,F),m!==void 0))return m}else b<I&&ae(u++,d+1,b,I,A,D,16,-1/0,1/0),I<R&&(ae(u++,d+1,I,R,A,D,0,-1/0,1/0),ae(u++,d+1,A,D,I,R,1,-1/0,1/0))}}else C?R=Do(e,d,b,v,E,L,U):R=br(e,d,b,v,E,L,U),b<R&&(d===e-2?C?m=Ce.sweepBipartite(e,t,A,D,w,F,b,R,E,L):m=Ce.sweepBipartite(e,t,b,R,E,L,A,D,w,F):(ae(u++,d+1,b,R,A,D,C,-1/0,1/0),ae(u++,d+1,A,D,b,R,C^1,-1/0,1/0)))}}}}}var $o=jo,we=B,ft=Sn,No=Lo;function Vo(e,t){for(var r=0;r<e;++r)if(!(t[r]<=t[r+e]))return!0;return!1}function Ar(e,t,r,n){for(var i=0,a=0,s=0,o=e.length;s<o;++s){var c=e[s];if(!Vo(t,c)){for(var u=0;u<2*t;++u)r[i++]=c[u];n[a++]=s}}return a}function Et(e,t,r,n){var i=e.length,a=t.length;if(!(i<=0||a<=0)){var s=e[0].length>>>1;if(!(s<=0)){var o,c=we.mallocDouble(2*s*i),u=we.mallocInt32(i);if(i=Ar(e,s,c,u),i>0){if(s===1&&n)ft.init(i),o=ft.sweepComplete(s,r,0,i,c,u,0,i,c,u);else{var h=we.mallocDouble(2*s*a),m=we.mallocInt32(a);a=Ar(t,s,h,m),a>0&&(ft.init(i+a),s===1?o=ft.sweepBipartite(s,r,0,i,c,u,0,a,h,m):o=No(s,r,n,i,c,u,a,h,m),we.free(h),we.free(m))}we.free(c),we.free(u)}return o}}}var ot;function $n(e,t){ot.push([e,t])}function Ho(e){return ot=[],Et(e,e,$n,!0),ot}function Go(e,t){return ot=[],Et(e,t,$n,!1),ot}function jo(e,t,r){switch(arguments.length){case 1:return Ho(e);case 2:return typeof t=="function"?Et(e,e,t,!0):Go(e,t);case 3:return Et(e,t,r,!1);default:throw new Error("box-intersect: Invalid arguments")}}function Ko(e){var t=[];return{name:"collideEntities",order:70,state:{cylinder:!1,collideBits:1,collideMask:1,callback:null},onAdd:null,onRemove:null,system:function(c,u){for(var h=e.ents,m=0;m<u.length;m++){var p=u[m].__id,d=h.getPositionData(p);t[m]=d._extents}t.length=u.length,$o(t,function(l,v){var f=u[l],y=u[v];if(!(!f||!y)){var g=t[l],k=t[v];n(f,y,g,k)&&r(e,f,y)}})}};function r(o,c,u){var h=c.__id,m=u.__id;c.collideMask&u.collideBits&&c.callback&&c.callback(m),u.collideMask&c.collideBits&&u.callback&&u.callback(h),o.ents.onPairwiseEntityCollision(h,m)}function n(o,c,u,h){return o.cylinder?c.cylinder?i(u,h):a(u,h):c.cylinder?a(h,u):!0}function i(o,c){var u=(o[3]-o[0])/2,h=(c[3]-c[0])/2,m=o[0]+u-(c[0]+h),p=o[2]+u-(c[2]+h),d=m*m+p*p,l=u+h;return d<=l*l}function a(o,c){var u=(o[3]-o[0])/2,h=o[0]+u,m=o[2]+u,p=s(h,c[0],c[3]),d=s(m,c[2],c[5]),l=p-h,v=d-m,f=l*l+v*v;return f<=u*u}function s(o,c,u){return o<c?c:o>u?u:o}}function Yo(e){return{name:"collideTerrain",order:0,state:{callback:null},onAdd:function(t,r){var n=e.entities;if(n.hasPhysics(t)){var i=n.getPhysics(t).body;i.onCollide=function(s){var o=e.ents.getCollideTerrain(t).callback;o&&o(s,t)}}},onRemove:function(t,r){var n=e.entities;n.hasPhysics(t)&&(n.getPhysics(t).body.onCollide=null)}}}function Wo(e){return{name:"fadeOnZoom",order:99,state:{cutoff:1.5},onAdd:null,onRemove:null,system:function(r,n){for(var i=e.camera.currentZoom,a=0;a<n.length;a++)Zo(n[a],i,e)}}}function Zo(e,t,r){if(!!r.ents.hasMesh(e.__id)){var n=r.ents.getMeshData(e.__id).mesh;if(!!n.metadata){var i=t<e.cutoff;r.rendering.setMeshVisibility(n,!i)}}}function Xo(e){return{name:"followsEntity",order:50,state:{entity:0,offset:null,onTargetMissing:null},onAdd:function(n,i){var a=T.create();i.offset=i.offset?T.copy(a,i.offset):a,t(i),r(i)},onRemove:null,system:function(i,a){for(var s=0;s<a.length;s++)t(a[s])},renderSystem:function(i,a){for(var s=0;s<a.length;s++)r(a[s])}};function t(n){var i=n.__id,a=e.ents.getPositionData(i),s=e.ents.getPositionData(n.entity);s?T.add(a._localPosition,s._localPosition,n.offset):(n.onTargetMissing&&n.onTargetMissing(i),e.ents.removeComponent(i,e.ents.names.followsEntity))}function r(n){var i=n.__id,a=e.ents.getPositionData(i),s=e.ents.getPositionData(n.entity);s&&T.add(a._renderPosition,s._renderPosition,n.offset)}}function Qo(e){return{name:"mesh",order:100,state:{mesh:null,offset:null},onAdd:function(t,r){var n=e.ents.getPositionData(t);if(r.mesh)e.rendering.addMeshToScene(r.mesh,!1,n.position);else throw new Error("Mesh component added without a mesh - probably a bug!");r.offset||(r.offset=T.create());var i=n._renderPosition;r.mesh.position.copyFromFloats(i[0]+r.offset[0],i[1]+r.offset[1],i[2]+r.offset[2])},onRemove:function(t,r){r.mesh.dispose()},renderSystem:function(t,r){for(var n=0;n<r.length;n++){var i=r[n],a=i.__id,s=e.ents.getPositionData(a)._renderPosition;i.mesh.position.copyFromFloats(s[0]+i.offset[0],s[1]+i.offset[1],s[2]+i.offset[2])}}}}function Jo(){this.heading=0,this.running=!1,this.jumping=!1,this.maxSpeed=10,this.moveForce=30,this.responsiveness=15,this.runningFriction=0,this.standingFriction=2,this.airMoveMult=.5,this.jumpImpulse=10,this.jumpForce=12,this.jumpTime=500,this.airJumps=1,this._jumpCount=0,this._currjumptime=0,this._isJumping=!1}function eu(e){return{name:"movement",order:30,state:new Jo,onAdd:null,onRemove:null,system:function(r,n){for(var i=e.entities,a=0;a<n.length;a++){var s=n[a],o=i.getPhysics(s.__id);o&&iu(r,s,o.body)}}}}var tu=T.create(),ru=T.create(),nu=T.create();function iu(e,t,r){var n=r.atRestY()<0,i=n||t._jumpCount<t.airJumps;if(n&&(t._isJumping=!1,t._jumpCount=0),t.jumping)if(t._isJumping){if(t._currjumptime>0){var a=t.jumpForce;t._currjumptime<e&&(a*=t._currjumptime/e),r.applyForce([0,a,0]),t._currjumptime-=e}}else i&&(t._isJumping=!0,n||t._jumpCount++,t._currjumptime=t.jumpTime,r.applyImpulse([0,t.jumpImpulse,0]),!n&&r.velocity[1]<0&&(r.velocity[1]=0));else t._isJumping=!1;var s=tu,o=ru;if(t.running){var c=t.maxSpeed;T.set(s,0,0,c),T.rotateY(s,s,nu,t.heading),T.subtract(o,s,r.velocity),o[1]=0;var u=T.length(o);if(T.normalize(o,o),u>0){var h=t.moveForce;n||(h*=t.airMoveMult);var m=t.responsiveness*u;h>m&&(h=m),T.scale(o,o,h),r.applyForce(o)}r.friction=t.runningFriction}else r.friction=t.standingFriction}function au(e){return{name:"receivesInputs",order:20,state:{},onAdd:null,onRemove:null,system:function(r,n){for(var i=e.entities,a=e.inputs.state,s=e.camera.heading,o=0;o<n.length;o++){var c=n[o],u=i.getMovement(c.__id);su(u,a,s)}}}}function su(e,t,r){e.jumping=!!t.jump;var n=t.forward?t.backward?0:1:t.backward?-1:0,i=t.right?t.left?0:1:t.left?-1:0;(n|i)===0?e.running=!1:(e.running=!0,n?(n==-1&&(r+=Math.PI),i&&(r+=Math.PI/4*n*i)):r+=i*Math.PI/2,e.heading=r)}function ou(e,t=10){var r=t,n=e.rendering.getScene(),i=Jn("shadow",{radius:.75,tessellation:30},n);i.rotation.x=Math.PI/2;var a=e.rendering.makeStandardMaterial("shadow_component_mat");return a.diffuseColor.set(0,0,0),a.ambientColor.set(0,0,0),a.alpha=.5,i.material=a,a.freeze(),e.rendering.setMeshVisibility(i,!1),{name:"shadow",order:80,state:{size:.5,_mesh:null},onAdd:function(s,o){var c=i.createInstance("shadow_instance");e.rendering.addMeshToScene(c),c.setEnabled(!1),o._mesh=c},onRemove:function(s,o){o._mesh.dispose(),o._mesh=null},system:function(o,c){for(var u=e.camera._localGetPosition(),h=r,m=0;m<c.length;m++){var p=c[m],d=e.ents.getPositionData(p.__id),l=e.ents.getPhysics(p.__id);cu(e,d,l,p._mesh,p.size,h,u)}},renderSystem:function(s,o){for(var c=0;c<o.length;c++){var u=o[c],h=e.ents.getPositionData(u.__id)._renderPosition,m=u._mesh.position;m.x=h[0],m.z=h[2]}}}}var Nt=T.fromValues(0,0,0),uu=T.fromValues(0,-1,0);function cu(e,t,r,n,i,a,s){var o;if(r&&r.body.resting[1]<0)o=t._localPosition[1];else{var c=e._localPick(t._localPosition,uu,a);if(!c){n.setEnabled(!1);return}o=c.position[1]-e.worldOriginOffset[1]}o=Math.round(o),T.copy(Nt,t._localPosition),Nt[1]=o;var u=T.squaredDistance(s,Nt),h=.01+.1*(u/1600);h>.1&&(h=.1),n.position.y=o+h;var m=t._localPosition[1]-o,p=i*.7*(1-m/a);n.scaling.copyFromFloats(p,p,p),n.setEnabled(!0)}function lu(e){var t="smoothCamera";return{name:t,order:99,state:{time:100.1},onAdd:null,onRemove:null,system:function(r,n){for(var i=0;i<n.length;i++){var a=n[i];a.time-=r,a.time<0&&e.ents.removeComponent(a.__id,t)}}}}var hu={shadowDistance:10};class fu extends Ws{constructor(t,r){super(),r=Object.assign({},hu,r);var n={shadow:r.shadowDistance};this.noa=t,this.names={};var i={collideEntities:Ko,collideTerrain:Yo,fadeOnZoom:Wo,followsEntity:Xo,mesh:Qo,movement:eu,physics:to,position:Js,receivesInputs:au,shadow:ou,smoothCamera:lu};Object.keys(i).forEach(a=>{var s=n[a]||void 0,o=i[a],c=o(t,s);this.names[a]=this.createComponent(c)}),this.cameraSmoothed=this.getComponentAccessor(this.names.smoothCamera),this.hasPhysics=this.getComponentAccessor(this.names.physics),this.hasPosition=this.getComponentAccessor(this.names.position),this.getPositionData=this.getStateAccessor(this.names.position),this.getPosition=a=>{var s=this.getPositionData(a);return s?s.position:null},this.getPhysics=this.getStateAccessor(this.names.physics),this.getPhysicsBody=a=>{var s=this.getPhysics(a);return s?s.body:null},this.hasMesh=this.getComponentAccessor(this.names.mesh),this.getMeshData=this.getStateAccessor(this.names.mesh),this.getMovement=this.getStateAccessor(this.names.movement),this.getCollideTerrain=this.getStateAccessor(this.names.collideTerrain),this.getCollideEntities=this.getStateAccessor(this.names.collideEntities),this.onPairwiseEntityCollision=function(a,s){}}setPosition(t,r,n=0,i=0){typeof r=="number"&&(r=[r,n,i]);var a=this.noa.globalToLocal(r,null,[]);this._localSetPosition(t,a)}setEntitySize(t,r,n,i){var a=this.getPositionData(t);a.width=(r+i)/2,a.height=n,this._updateDerivedPositionData(t,a)}_rebaseOrigin(t){for(var r of this.getStatesList(this.names.position)){var n=r._localPosition,i=r.width/2;Vt(n,0,-i,i,r.__id),Vt(n,1,0,r.height,r.__id),Vt(n,2,-i,i,r.__id),T.subtract(n,n,t),this._updateDerivedPositionData(r.__id,r)}}_localGetPosition(t){return this.getPositionData(t)._localPosition}_localSetPosition(t,r){var n=this.getPositionData(t);T.copy(n._localPosition,r),this._updateDerivedPositionData(t,n)}_updateDerivedPositionData(t,r){T.copy(r._renderPosition,r._localPosition);var n=this.noa.worldOriginOffset;T.add(r.position,r._localPosition,n),tr(r);var i=this.getPhysics(t);i&&kn(i,r)}addComponentAgain(t,r,n){this.hasComponent(t,r)&&this.removeComponent(t,r),this.addComponent(t,r,n)}isTerrainBlocked(t,r,n){for(var i=this.noa.worldOriginOffset,a=Math.floor(t-i[0]),s=Math.floor(r-i[1]),o=Math.floor(n-i[2]),c=[a+.001,s+.001,o+.001,a+.999,s+.999,o+.999],u=this.getStatesList(this.names.collideTerrain),h=0;h<u.length;h++){var m=u[h].__id,p=this.getPositionData(m)._extents;if(xr(c,p))return!0}return!1}getEntitiesInAABB(t,r){var n=this.noa.worldOriginOffset,i=[t.base[0]-n[0],t.base[1]-n[1],t.base[2]-n[2],t.max[0]-n[0],t.max[1]-n[1],t.max[2]-n[2]],a;if(r){a=[];for(var s of this.getStatesList(r)){var o=this.getPositionData(s.__id);o&&a.push(o)}}else a=this.getStatesList(this.names.position);for(var c=[],u=0;u<a.length;u++){var h=a[u];xr(i,h._extents)&&c.push(h.__id)}return c}add(t=null,r=1,n=1,i=null,a=null,s=!1,o=!1){var c=this,u=this.createEntity();if(this.addComponent(u,this.names.position,{position:t||T.create(),width:r,height:n}),s){this.addComponent(u,this.names.physics);var h=this.getPhysics(u).body,m=this.names.smoothCamera;h.onStep=function(){c.addComponentAgain(u,m)}}return i&&(a||(a=T.create()),this.addComponent(u,this.names.mesh,{mesh:i,offset:a})),o&&this.addComponent(u,this.names.shadow,{size:r}),u}}function Vt(e,t,r,n,i){var a=e[t]+r,s=e[t]+n;Math.abs(a-Math.round(a))<.002&&(e[t]+=.002),Math.abs(s-Math.round(s))<.001&&(e[t]-=.001)}function xr(e,t){return!(e[0]>t[3]||e[1]>t[4]||e[2]>t[5]||e[3]<t[0]||e[4]<t[1]||e[5]<t[2])}function Je(e,t){var r=e.indexOf(t);r<0||(r===e.length-1?e.pop():e[r]=e.pop())}function le(e,t,r){return e&1023|(t&1023)<<10|(r&1023)<<20}class vu{constructor(){this.hash={}}getChunkByIndexes(t=0,r=0,n=0){return this.hash[le(t,r,n)]||null}storeChunkByIndexes(t=0,r=0,n=0,i){this.hash[le(t,r,n)]=i}removeChunkByIndexes(t=0,r=0,n=0){delete this.hash[le(t,r,n)]}}class ge{constructor(){this.arr=[],this.hash={}}forEach(t,r){this.arr.forEach(t,r)}includes(t,r,n){var i=le(t,r,n);return!!this.hash[i]}add(t,r,n,i=!1){var a=le(t,r,n);this.hash[a]||(i?this.arr.unshift([t,r,n,a]):this.arr.push([t,r,n,a]),this.hash[a]=!0)}removeByIndex(t){var r=this.arr[t];delete this.hash[r[3]],this.arr.splice(t,1)}remove(t,r,n){var i=le(t,r,n);if(!!this.hash[i]){delete this.hash[i];for(var a=0;a<this.arr.length;a++)if(i===this.arr[a][3]){this.arr.splice(a,1);return}throw"internal bug with location queue - hash value overlapped"}}count(){return this.arr.length}isEmpty(){return this.arr.length===0}empty(){this.arr=[],this.hash={}}pop(){var t=this.arr.pop();return delete this.hash[t[3]],t}copyFrom(t){this.arr=t.arr.slice(),this.hash={};for(var r in t.hash)this.hash[r]=!0}sortByDistance(t,r=!1){du(this.arr,t,r)}}function du(e,t,r){var n={};for(var i of e)n[i[3]]=t(i[0],i[1],i[2]);r?e.sort((a,s)=>n[a[3]]-n[s[3]]):e.sort((a,s)=>n[s[3]]-n[a[3]]),n=null}function pu(e,t="",r){if(!(e>0))return()=>{};var n={},i=0,a=0,s=0,o=0,c=()=>{i=a=performance.now(),s++},u=m=>{var p=performance.now();n[m]=(n[m]||0)+(p-a),a=p},h=()=>{if(o+=performance.now()-i,!(s<e)){var m=`${t}: ${(o/e).toFixed(2)}ms  --  `;m+=Object.keys(n).map(p=>r&&n[p]/o<.05?"":`${p}: ${(n[p]/s).toFixed(2)}ms`).join("  "),console.log(m+`    (avg over ${e} runs)`),n={},s=o=0}};return m=>{m==="start"?c():m==="end"?h():u(m)}}function mu(e){this.rootNode=new Xt("objectMeshRoot",e.rendering.scene);var t=[0,0,0],r=!1,n=new Xt("");this.allBaseMeshes=[];var i={},a=o=>{if(i[o])return i[o];var c=e.registry._blockMeshLookup[o];for(var u in i){var h=i[u].mesh;if(h===c||h.geometry===c.geometry)return i[o]=i[u]}return this.allBaseMeshes.push(c),c.metadata||(c.metadata={}),c.metadata[s]=!0,i[o]=new Ye(e,c)},s="noa_object_base_mesh";this.initChunk=function(o){o._objectBlocks={}},this.setObjectBlock=function(o,c,u,h,m){var p=o.x+u,d=o.y+h,l=o.z+m,v=`${p}:${d}:${l}`,f=o._objectBlocks[v]||0;if(f!==c){if(f>0){var y=a(f);y.removeInstance(o,v)}if(c>0){var g=e.registry._blockHandlerLookup[c],k=g&&g.onCustomMeshCreate;k&&(n.position.copyFromFloats(.5,0,.5),n.scaling.setAll(1),n.rotation.setAll(0),k(n,p,d,l));var _=a(c),M=k?n:null;_.addInstance(o,v,u,h,m,M,t)}f>0&&!c&&delete o._objectBlocks[v],c>0&&(o._objectBlocks[v]=c)}},this.buildObjectMeshes=function(){for(var o in i){var c=i[o];c.updateMatrix(),c.count===0&&c.dispose(),c.disposed&&delete i[o]}},this.disposeChunk=function(o){for(var c in o._objectBlocks){var u=o._objectBlocks[c];if(u>0){var h=a(u);h.removeInstance(o,c)}}o._objectBlocks=null,r=!0},this.tick=function(){r&&(this.buildObjectMeshes(),r=!1)},this._rebaseOrigin=function(o){t[0]+=o[0],t[1]+=o[1],t[2]+=o[2];for(var c in i)i[c].rebased=!1;for(var u in i){var h=i[u];if(!h.rebased){for(var m=0;m<h.count;m++){var p=m<<4;h.buffer[p+12]-=o[0],h.buffer[p+13]-=o[1],h.buffer[p+14]-=o[2]}h.rebased=!0,h.dirty=!0}}r=!0}}function Ye(e,t){this.noa=e,this.mesh=t,this.buffer=null,this.capacity=0,this.count=0,this.dirty=!1,this.rebased=!0,this.disposed=!1,this.keyToIndex={},this.locToKey=[],this.mesh.position.setAll(0),this.mesh.parent=e._objectMesher.rootNode,this.noa.rendering.addMeshToScene(this.mesh,!1),this.noa.emit("addingTerrainMesh",this.mesh),this.mesh.isPickable=!1,this.mesh.doNotSyncBoundingInfo=!0,this.mesh.alwaysSelectAsActiveMesh=!0}Ye.prototype.dispose=function(){this.disposed||(this.mesh.thinInstanceCount=0,this.setCapacity(0),this.noa.emit("removingTerrainMesh",this.mesh),this.noa.rendering.setMeshVisibility(this.mesh,!1),this.mesh=null,this.keyToIndex=null,this.locToKey=null,this.disposed=!0)};Ye.prototype.addInstance=function(e,t,r,n,i,a,s){gu(this);var o=this.count<<4;if(this.locToKey[this.count]=t,this.keyToIndex[t]=o,a){a.position.x+=e.x-s[0]+r,a.position.y+=e.y-s[1]+n,a.position.z+=e.z-s[2]+i,a.computeWorldMatrix(!0);var c=a._localMatrix._m;nr(c,0,this.buffer,o)}else{var u=_u;u[12]=e.x-s[0]+r+.5,u[13]=e.y-s[1]+n,u[14]=e.z-s[2]+i+.5,nr(u,0,this.buffer,o)}this.count++,this.dirty=!0};Ye.prototype.removeInstance=function(e,t){var r=this.keyToIndex[t];if(!(r>=0))throw"tried to remove object instance not in storage";delete this.keyToIndex[t];var n=r>>4,i=this.count-1;if(n!==i){var a=i<<4;nr(this.buffer,a,this.buffer,r);var s=this.locToKey[i];this.keyToIndex[s]=r,this.locToKey[n]=s}this.count--,this.dirty=!0,yu(this)};Ye.prototype.updateMatrix=function(){!this.dirty||(this.mesh.thinInstanceCount=this.count,this.mesh.thinInstanceBufferUpdated("matrix"),this.mesh.isVisible=this.count>0,this.dirty=!1)};Ye.prototype.setCapacity=function(e=4){if(this.capacity=e,e===0)this.buffer=null;else{var t=new Float32Array(this.capacity*16);if(this.buffer)for(var r=Math.min(this.buffer.length,t.length),n=0;n<r;n++)t[n]=this.buffer[n];this.buffer=t}this.mesh.thinInstanceSetBuffer("matrix",this.buffer),this.updateMatrix()};function gu(e){if(!(e.count<e.capacity)){var t=Math.max(8,e.capacity*2);e.setCapacity(t)}}function yu(e){e.count>e.capacity*.4||e.capacity<100||(e.setCapacity(Math.round(e.capacity/2)),e.locToKey.length=Math.min(e.locToKey.length,e.capacity))}var _u=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];function nr(e,t,r,n){for(var i=0;i<16;i++)r[n+i]=e[t+i]}class ku{constructor(t){this._defaultMat=t.rendering.makeStandardMaterial("base-terrain"),this._defaultMat.freeze(),this.allMaterials=[this._defaultMat],this.noa=t,this._idCounter=1e3,this._blockMatIDtoTerrainID={},this._terrainIDtoMatObject={},this._texURLtoTerrainID={},this._renderMatToTerrainID=new Map}getTerrainMatId(t){if(t in this._blockMatIDtoTerrainID)return this._blockMatIDtoTerrainID[t];var r=Mu(this,t);if(!(r in this._terrainIDtoMatObject)){var n=Cu(this,t);this.allMaterials.push(n),this._terrainIDtoMatObject[r]=n}return this._blockMatIDtoTerrainID[t]=r,r}getMaterial(t=1){return this._terrainIDtoMatObject[t]}}function Mu(e,t=0){var r=e.noa.registry.getMaterialData(t);if(r.renderMat){var n=r.renderMat;return e._renderMatToTerrainID.has(n)||e._renderMatToTerrainID.set(n,e._idCounter++),e._renderMatToTerrainID.get(n)}if(r.texture){var i=r.texture;return i in e._texURLtoTerrainID||(e._texURLtoTerrainID[i]=e._idCounter++),e._texURLtoTerrainID[i]}var a=r.alpha;return a>0&&a<1?10+Math.round(a*100):1}function Cu(e,t=0){var r=e.noa.registry.getMaterialData(t);if(r.renderMat)return r.renderMat;if(!r.texture){var n=r.alpha>0&&r.alpha<1;if(!n)return e._defaultMat;var i="terrain-alpha-"+t,a=e.noa.rendering.makeStandardMaterial(i);return a.alpha=r.alpha,a.freeze(),a}var s=e.noa.rendering.getScene(),o=e.noa.rendering.makeStandardMaterial("terrain-textured-"+t),c=r.texture,u=Qt.NEAREST_SAMPLINGMODE,h=new Qt(c,s,!0,!1,u);return r.texHasAlpha&&(h.hasAlpha=!0),o.diffuseTexture=h,r.atlasIndex>=0&&(new wu(o,h),e.noa.registry._textureNeedsAlpha(r.texture)&&(h.hasAlpha=!0)),o.freeze(),o}class wu extends ei{constructor(t,r){var n=200,i={NOA_TWOD_ARRAY_TEXTURE:!1};super(t,"TestPlugin",n,i),this._enable(!0),this._atlasTextureArray=null,r.onLoadObservable.add(a=>{this.setTextureArrayData(a)})}setTextureArrayData(t){var{width:r,height:n}=t.getSize(),i=Math.round(n/r);n=r;var a=t._readPixelsSync(),s=$r.TEXTUREFORMAT_RGBA,o=!0,c=!1,u=Qt.NEAREST_SAMPLINGMODE,h=t.getScene();this._atlasTextureArray=new ti(a,r,n,i,s,h,o,c,u)}prepareDefines(t,r,n){t.NOA_TWOD_ARRAY_TEXTURE=!0}getClassName(){return"TerrainMaterialPluginName"}getSamplers(t){t.push("atlasTexture")}getAttributes(t){t.push("texAtlasIndices")}getUniforms(){return{ubo:[]}}bindForSubMesh(t,r,n,i){this._atlasTextureArray&&t.setTexture("atlasTexture",this._atlasTextureArray)}getCustomCode(t){return t==="vertex"?{CUSTOM_VERTEX_MAIN_BEGIN:`
                texAtlasIndex = texAtlasIndices;
            `,CUSTOM_VERTEX_DEFINITIONS:`
                uniform highp sampler2DArray atlasTexture;
                attribute float texAtlasIndices;
                varying float texAtlasIndex;
            `}:t==="fragment"?{"!baseColor\\=texture2D\\(diffuseSampler,vDiffuseUV\\+uvOffset\\);":"baseColor = texture(atlasTexture, vec3(vDiffuseUV, texAtlasIndex));",CUSTOM_FRAGMENT_DEFINITIONS:`
                uniform highp sampler2DArray atlasTexture;
                varying float texAtlasIndex;
            `}:null}}function Tu(e){var t=new ku(e);this.allTerrainMaterials=t.allMaterials,this._defaultMaterial=t._defaultMat;var r=new Fu(e,t),n=new Lu(e,t);this.initChunk=function(a){a._terrainMeshes.length=0},this.disposeChunk=function(a){a._terrainMeshes.forEach(s=>{e.emit("removingTerrainMesh",s),s.dispose()}),a._terrainMeshes.length=0},this.meshChunk=function(a,s=!1){this.disposeChunk(a);var o=r.mesh(a,s),c=n.buildMesh(a,o,s);c.forEach(u=>{u.cullingStrategy=Nr.CULLINGSTRATEGY_BOUNDINGSPHERE_ONLY,e.rendering.addMeshToScene(u,!0,a.pos,this),e.emit("addingTerrainMesh",u),u.freezeNormals(),u.freezeWorldMatrix(),a._terrainMeshes.push(u),u.metadata||(u.metadata={}),u.metadata[i]=!0})};var i="noa_chunk_terrain_mesh"}function Eu(){this.terrainID=0,this.numFaces=0,this.matIDs=[],this.dirs=[],this.is=[],this.js=[],this.ks=[],this.wids=[],this.hts=[],this.packedAO=[]}function Fu(e,t){var r=new Int16Array(16),n=new Int16Array(16),i=t.getTerrainMatId.bind(t),a=_=>1,s=i;this.mesh=function(_,M){var C=_.size;s=M?a:i;var P=_._isEmpty||_._isFull,E={};Ir.reset();for(var L=0;L<3;++L){var w=L===2?0:2,F=L===1?0:1,x=_._neighbors.data.map(G=>G&&G.voxels?G.voxels.transpose(L,w,F):null),S=at(x,[3,3,3]).lo(1,1,1).transpose(L,w,F);r.length<C*C&&(r=new Int16Array(C*C),n=new Int16Array(C*C)),o(S,C);var b=S.get(-1,0,0),A=S.get(0,0,0);if(b){var U=b.lo(C,0,0),D=f(L,U,-1,A,0);D>0&&y(0,L,w,F,C,C,D,E)}if(!P)for(var R=0;R<C-1;R++){if(L===1){var I=_._wholeLayerVoxel[R];if(I>=0&&I===_._wholeLayerVoxel[R+1])continue}var $=L===1?null:_._wholeLayerVoxel,V=f(L,A,R,A,R+1,$);V>0&&y(R+1,L,w,F,C,C,V,E)}}return E};function o(_,M){if(c!==M){c=M,u=e.registry._solidityLookup;for(var C=-1;C<M+1;C++){var P=C<0?0:C<M?1:2;p[C+1]=[0,1,2][P],d[C+1]=[M-1,C,0][P],l[C+1]=[0,C,M-1][P]}}for(var E=_.get(0,0,0),L=0;L<3;L++)for(var w=0;w<3;w++)for(var F=0;F<3;F++){var x=L*9+w*3+F,S=_.get(L-1,w-1,F-1),b=0;S||(b=1),S===E&&(b=2),m[x]=b,h[x]=S||E}}var c=-1,u=[!1,!0],h=Array(27).fill(null),m=Array(27).fill(0),p=[0,1,1,1,1,1,2],d=[3,0,1,2,3,0],l=[0,0,1,2,3,3];function v(_,M,C){var P=p[_+1],E=p[M+1],L=p[C+1],w=P*9+E*3+L,F=h[w],x=m[w];if(x===2)return u[F.get(_,M,C)];var S=[d,l][x],b=S[_+1],A=S[M+1],U=S[C+1];return u[F.get(b,A,U)]}function f(_,M,C,P,E,L=null){for(var w=M.shape[1],F=r,x=n,S=e.rendering.useAO,b=e.rendering.revAoVal===e.rendering.aoVals[0],A=e.registry._opacityLookup,U=e.registry.getBlockFaceMaterial,D=_*2,R=0,I=M.index(C,0,0),$=M.stride[1],V=M.stride[2],G=P.index(E,0,0),fe=P.stride[1],Te=P.stride[2],se=0,oe=0;oe<w;++oe){var ue=I,ne=G;if(I+=V,G+=Te,L&&L[oe]>=0){R+=w;continue}for(var ie=0;ie<w;ie++,R++,ue+=$,ne+=fe){var Y=M.data[ue],W=P.data[ne];if(Y!==W){var ve=A[Y],de=A[W];if(!(ve&&de)){var Re=U(Y,D),We=U(W,D+1);Re!==We&&(ve||We===0?(F[R]=Re,S&&(x[R]=Sr(v,E,C,ie,oe,b)),se++):(de||Re===0)&&(F[R]=-We,S&&(x[R]=Sr(v,C,E,ie,oe,b)),se++))}}}}return se}function y(_,M,C,P,E,L,w,F){var x=e.rendering.useAO,S=r,b=n,A=0,U=M*2,D=[0,0,0];D[M]=_;for(var R=x?g:k,I=0;I<L;++I)for(var $=1,V=1,G=0;G<E;G+=$,A+=$){var fe=S[A]|0;if(!fe){$=1;continue}var Te=b[A]|0;for($=1;$<E-G&&R(A+$,S,fe,b,Te);++$);e:for(V=1;V<L-I;++V)for(var se=0;se<$;++se){var oe=A+se+V*E;if(!R(oe,S,fe,b,Te))break e}var ue=Math.abs(fe),ne=s(ue);if(!(ne in F)){var ie=Ir.get();ie.numFaces=0,ie.terrainID=ne,F[ne]=ie}var Y=F[ne],W=Y.numFaces;Y.numFaces++,Y.matIDs[W]=ue,D[C]=G,D[P]=I,Y.is[W]=D[0],Y.js[W]=D[1],Y.ks[W]=D[2],Y.wids[W]=$,Y.hts[W]=V,Y.packedAO[W]=Te,Y.dirs[W]=fe>0?U:U+1;for(var ve=0;ve<V;++ve)for(var de=0;de<$;++de)S[A+de+ve*E]=0;if(w-=$*V,w===0)return}}function g(_,M,C,P,E){return!(C!==M[_]||E!==P[_])}function k(_,M,C,P,E){return C===M[_]}}var Ir=(()=>{var e=[],t=0,r=()=>(t>=e.length&&e.push(new Eu),t++,e[t-1]),n=()=>{t=0};return{get:r,reset:n}})();function Lu(e,t){this.buildMesh=function(p,d,l){var v=e.rendering.getScene(),f=e.rendering.useAO,y=e.rendering.aoVals,g=e.rendering.revAoVal,k=e.registry._matAtlasIndexLookup,_=e.registry._materialColorLookup,M=[1,1,1],C=[];for(var P in d){var E=d[P],L=E.terrainID,w=!1;if(!l){var F=k[E.matIDs[0]];w=F>=0}var x=E.numFaces,S=new Uint16Array(x*6),b=new Float32Array(x*12),A=new Float32Array(x*12),U=new Float32Array(x*16),D=new Float32Array(x*8),R;w&&(R=new Float32Array(x*4));for(var I=0;I<E.numFaces;I++){var $=E.matIDs[I],V=E.dirs[I],G=E.is[I],fe=E.js[I],Te=E.ks[I],se=E.wids[I],oe=E.hts[I],ue=V/2|0,ne=V%2?-1:1;r(b,I,G,fe,Te,ue,se,oe),n(D,I,ue,se,oe,ne);var ie=[0,0,0];ie[ue]=ne,i(A,I,ie);var Y=E.packedAO[I],[W,ve,de,Re]=Pu(Y),We=c(W,ve,de,Re);if(a(S,I,ue,ne,We),w){var Xn=k[$];o(R,I,Xn)}var vr=_[$]||M;f?h(U,I,vr,y,g,W,ve,de,Re):u(U,I,vr)}var Qn=`chunk_${p.requestID}_${L}`,ke=new Nr(Qn,v),Oe=new ri;Oe.positions=b,Oe.indices=S,Oe.normals=A,Oe.colors=U,Oe.uvs=D,Oe.applyToMesh(ke),w&&ke.setVerticesData("texAtlasIndices",R,!1,1),ke.isPickable=!1,ke.doNotSyncBoundingInfo=!0,ke._refreshBoundingInfo=()=>ke,l||(ke.material=t.getMaterial(L)),C.push(ke)}return C};function r(p,d,l,v,f,y,g,k){var _=d*12,M=[l,v,f],C=[0,0,0],P=[0,0,0];C[y===2?0:2]=g,P[y===1?0:1]=k;for(var E=0;E<3;E++)p[_+E]=M[E],p[_+3+E]=M[E]+C[E],p[_+6+E]=M[E]+C[E]+P[E],p[_+9+E]=M[E]+P[E]}function n(p,d,l,v,f,y){for(var g=d*8,k=0,_=0;_<8;_++)p[g+_]=k;l===0?(p[g+1]=p[g+3]=f-k,p[g+2]=p[g+4]=y*v):l===1?(p[g+1]=p[g+7]=v-k,p[g+4]=p[g+6]=y*f):(p[g+1]=p[g+3]=f-k,p[g+2]=p[g+4]=-y*v)}function i(p,d,l){for(var v=d*12,f=0;f<12;f++)p[v+f]=l[f%3]}function a(p,d,l,v,f){var y=d*6,g=d*4;l===0&&(v=-v);var k=v<0?0:1;f||(k+=2);for(var _=s[k],M=0;M<6;M++)p[y+M]=g+_[M]}var s=[[0,1,2,0,2,3],[0,2,1,0,3,2],[1,2,3,1,3,0],[1,3,2,1,0,3]];function o(p,d,l){for(var v=d*4,f=0;f<4;f++)p[v+f]=l}function c(p,d,l,v){return p===l?v===d?v===2:!0:v===d?!1:p+l>v+d}function u(p,d,l){for(var v=d*16,f=0;f<16;f+=4)p[v+f]=l[0],p[v+f+1]=l[1],p[v+f+2]=l[2],p[v+f+3]=1}function h(p,d,l,v,f,y,g,k,_){var M=d*16;m(p,M,l,y,v,f),m(p,M+4,l,_,v,f),m(p,M+8,l,k,v,f),m(p,M+12,l,g,v,f)}function m(p,d,l,v,f,y){var g=v===0?y:f[v-1];p[d]=l[0]*g,p[d+1]=l[1]*g,p[d+2]=l[2]*g,p[d+3]=1}}function Sr(e,t,r,n,i,a=!1){var s=1,o=1,c=1,u=1;e(t,n+1,i)&&(++c,++u),e(t,n-1,i)&&(++s,++o),e(t,n,i+1)&&(++o,++u),e(t,n,i-1)&&(++s,++c);var h=e(t,n,i);return h?(u=u===3||e(t,n+1,i+1)?3:2,o=o===3||e(t,n-1,i+1)?3:2,c=c===3||e(t,n+1,i-1)?3:2,s=s===3||e(t,n-1,i-1)?3:2,u<<6|c<<4|o<<2|s):a?(u===1&&e(t,n+1,i+1)&&(u=2),o===1&&e(t,n-1,i+1)&&(o=2),c===1&&e(t,n+1,i-1)&&(c=2),s===1&&e(t,n-1,i-1)&&(s=2),u<<6|c<<4|o<<2|s):(u===1&&(e(t,n+1,i+1)?u=2:(!e(r,n,i+1)||!e(r,n+1,i)||!e(r,n+1,i+1))&&(u=0)),c===1&&(e(t,n+1,i-1)?c=2:(!e(r,n,i-1)||!e(r,n+1,i)||!e(r,n+1,i-1))&&(c=0)),o===1&&(e(t,n-1,i+1)?o=2:(!e(r,n,i+1)||!e(r,n-1,i)||!e(r,n-1,i+1))&&(o=0)),s===1&&(e(t,n-1,i-1)?s=2:(!e(r,n,i-1)||!e(r,n-1,i)||!e(r,n-1,i-1))&&(s=0)),u<<6|c<<4|o<<2|s)}function Pu(e){var t=e&3,r=e>>2&3,n=e>>4&3,i=e>>6&3;return[t,r,i,n]}var bu={texturePath:""},Au=(1<<16)-1;class xu{constructor(t,r){r=Object.assign({},bu,r),this.noa=t,this._texturePath=r.texturePath;var n={},i=[!1],a=[!1],s=[!1],o=[!1],c=[null],u=[null],h=[null],m=[!1],p=[0,0,0,0,0,0],d=[null],l=[-1],v=[];this.registerBlock=function(f=1,y=null){var g=new Ru(y&&y.fluid),k=Object.assign({},g,y||{});if(f<1||f>Au)throw"Block id out of range: "+f;for(;f>i.length;)this.registerBlock(i.length,{});i[f]=!!k.solid,a[f]=!!k.opaque,s[f]=!!k.fluid,o[f]=!!k.blockMesh,u[f]=k.blockMesh||null;var _=k.material||null,M;if(!_)M=[null,null,null,null,null,null];else if(typeof _=="string")M=[_,_,_,_,_,_];else if(_.length&&_.length==2)M=[_[1],_[1],_[0],_[0],_[1],_[1]];else if(_.length&&_.length==3)M=[_[2],_[2],_[0],_[1],_[2],_[2]];else if(_.length&&_.length==6)M=_;else throw"Invalid material parameter: "+_;for(var C=0;C<6;++C)p[f*6+C]=Iu(this,n,M[C],!0);c[f]={},s[f]&&(c[f].fluidDensity=k.fluidDensity,c[f].viscosity=k.viscosity);var P=k.onLoad||k.onUnload||k.onSet||k.onUnset||k.onCustomMeshCreate;h[f]=P?new Su(k):null;var E=i[f]&&a[f]&&!P&&!s[f]&&!o[f];return m[f]=E,f},this.registerMaterial=function(f="?",y=null){if(Array.isArray(y))throw'This API changed signatures in v0.33, please use: `noa.registry.registerMaterial("name", optionsObj)`';var g=Object.assign(new Ou,y||{}),k=n[f]||v.length;n[f]=k;var _=g.textureURL?this._texturePath+g.textureURL:"",M=1,C=g.color||[1,1,1];return C.length===4&&(M=C.pop()),_&&(C=null),d[k]=C,l[k]=g.atlasIndex,v[k]={color:C,alpha:M,texture:_,texHasAlpha:!!g.texHasAlpha,atlasIndex:g.atlasIndex,renderMat:g.renderMaterial},k},this.getBlockSolidity=function(f){return i[f]},this.getBlockOpacity=function(f){return a[f]},this.getBlockFluidity=function(f){return s[f]},this.getBlockProps=function(f){return c[f]},this.getBlockFaceMaterial=function(f,y){return p[f*6+y]},this.getMaterialData=function(f){return v[f]},this._textureNeedsAlpha=function(f=""){return v.some(y=>y.texture!==f?!1:y.texHasAlpha)},this._solidityLookup=i,this._opacityLookup=a,this._fluidityLookup=s,this._objectLookup=o,this._blockMeshLookup=u,this._blockHandlerLookup=h,this._blockIsPlainLookup=m,this._materialColorLookup=d,this._matAtlasIndexLookup=l,this.registerMaterial("dirt",{color:[.4,.3,0]}),this.registerBlock(1,{material:"dirt"})}}function Iu(e,t,r,n){if(!r)return 0;var i=t[r];return i===void 0&&n&&(i=e.registerMaterial(r)),i}function Su(e){this.onLoad=e.onLoad||null,this.onUnload=e.onUnload||null,this.onSet=e.onSet||null,this.onUnset=e.onUnset||null,this.onCustomMeshCreate=e.onCustomMeshCreate||null}function Ru(e=!1){this.solid=!e,this.opaque=!e,this.fluid=!1,this.material=null,this.blockMesh=null,this.fluidDensity=1,this.viscosity=.5,this.onLoad=null,this.onUnload=null,this.onSet=null,this.onUnset=null,this.onCustomMeshCreate=null}function Ou(){this.color=null,this.textureURL=null,this.texHasAlpha=!1,this.atlasIndex=-1,this.renderMaterial=null}class Du{constructor(t,r){var n=t.scene;n._addComponent(new ni(n));var i="noa_octree_block",a="noa_in_dynamic_list",s="noa_in_octree_block",o=new ii(u);n._selectionOctree=o,o.blocks=[];var c={};this.rebase=d=>{m(o,d)},this.addMesh=(d,l,v,f)=>{if(d.metadata||(d.metadata={}),!l){if(d.metadata[a])return;o.dynamicContent.push(d),d.metadata[a]=!0;return}var y=Math.floor(v[0]/h),g=Math.floor(v[1]/h),k=Math.floor(v[2]/h),_=le(y,g,k),M=c[_];if(!M){var C=[y*h,g*h,k*h],P=[0,0,0];t.noa.globalToLocal(C,null,P),M=p(P,h),o.blocks.push(M),c[_]=M,M._noaMapKey=_}M.entries.push(d),d.metadata[i]=M,d.metadata[s]=!0,d.alwaysSelectAsActiveMesh=!0},this.removeMesh=d=>{if(!!d.metadata&&(d.metadata[a]&&(Je(o.dynamicContent,d),d.metadata[a]=!1),d.metadata[s])){var l=d.metadata[i];l&&l.entries&&(Je(l.entries,d),l.entries.length===0&&(delete c[l._noaMapKey],Je(o.blocks,l))),d.metadata[i]=null,d.metadata[s]=!1}},this.setMeshVisibility=(d,l=!1)=>{if(d.metadata[i]){if(d.metadata[s]===l)return;var v=d.metadata[i];v&&v.entries&&(l?v.entries.push(d):Je(v.entries,d)),d.metadata[s]=l}else{if(d.metadata[a]===l)return;l?o.dynamicContent.push(d):Je(o.dynamicContent,d),d.metadata[a]=l}};var u=()=>{},h=r*t.noa.world._chunkSize,m=(d,l)=>{d.blocks.forEach(v=>{v.minPoint.subtractInPlace(l),v.maxPoint.subtractInPlace(l),v._boundingVectors.forEach(f=>f.subtractInPlace(l)),v.blocks&&m(v,l)})},p=(d,l)=>{var v=new ce(d[0],d[1],d[2]),f=new ce(d[0]+l,d[1]+l,d[2]+l);return new ai(v,f,void 0,void 0,void 0,u)}}}var Bu={showFPS:!1,antiAlias:!0,clearColor:[.8,.9,1],ambientColor:[.5,.5,.5],lightDiffuse:[1,1,1],lightSpecular:[1,1,1],lightVector:[1,-1,.5],useAO:!0,AOmultipliers:[.93,.8,.5],reverseAOmultiplier:1,preserveDrawingBuffer:!0,octreeBlockSize:2,renderOnResize:!0};class J{constructor(t,r,n){r=Object.assign({},Bu,r),this.noa=t,this.renderOnResize=!!r.renderOnResize,this.useAO=!!r.useAO,this.aoVals=r.AOmultipliers,this.revAoVal=r.reverseAOmultiplier,this.meshingCutoffTime=6,this.engine=null,this.scene=null,this.light=null,this.camera=null,this._initScene(n,r),r.showFPS&&$u()}_initScene(t,r){this.engine=new $r(t,r.antiAlias,{preserveDrawingBuffer:r.preserveDrawingBuffer});var n=new si(this.engine);this.scene=n,n.detachControl(),n.performancePriority=oi.Intermediate,n.autoClear=!0;var i=Math.round(r.octreeBlockSize);this._octreeManager=new Du(this,i),this._cameraHolder=new Xt("camHolder",n),this.camera=new ui("camera",new ce(0,0,0),n),this.camera.parent=this._cameraHolder,this.camera.minZ=.01,this._camScreen=Vr("camScreen",{size:10},n),this.addMeshToScene(this._camScreen),this._camScreen.position.z=.1,this._camScreen.parent=this.camera,this._camScreenMat=this.makeStandardMaterial("camera_screen_mat"),this._camScreen.material=this._camScreenMat,this._camScreen.setEnabled(!1),this._camScreenMat.freeze(),this._camLocBlock=0,n.clearColor=ci.FromArray(r.clearColor),n.ambientColor=nt.FromArray(r.ambientColor);var a=ce.FromArray(r.lightVector);this.light=new li("light",a,n),this.light.diffuse=nt.FromArray(r.lightDiffuse),this.light.specular=nt.FromArray(r.lightSpecular),n.skipPointerMovePicking=!0}}J.prototype.getScene=function(){return this.scene};J.prototype.tick=function(e){};J.prototype.render=function(){Uu(this),this.engine.beginFrame(),this.scene.render(),Nn(),this.engine.endFrame()};J.prototype.postRender=function(){};J.prototype.resize=function(){this.engine.resize(),this.noa._paused&&this.renderOnResize&&this.scene.render()};J.prototype.highlightBlockFace=function(e,t,r){var n=qu(this);if(e){this.noa.globalToLocal(t,null,Ee);for(var i=T.dist(this.noa.camera._localGetPosition(),Ee),a=.001+.001*i,s=0;s<3;s++)r[s]===0?Ee[s]+=.5:Ee[s]+=r[s]>0?1+a:-a;n.position.copyFromFloats(Ee[0],Ee[1],Ee[2]),n.rotation.x=r[1]?Math.PI/2:0,n.rotation.y=r[0]?Math.PI/2:0}n.setEnabled(e)};var Ee=[];J.prototype.addMeshToScene=function(e,t=!1,r=null,n=null){if(e.metadata||(e.metadata={}),e.metadata[kt]){this._octreeManager.setMeshVisibility(e,!0);return}if(e.metadata[kt]=!0,!e.parent){r||(r=e.position.asArray());var i=this.noa.globalToLocal(r,null,[]);e.position.fromArray(i)}this._octreeManager.addMesh(e,t,r,n),e.onDisposeObservable.add(()=>{this._octreeManager.removeMesh(e),e.metadata[kt]=!1})};var kt="noa_added_to_scene";J.prototype.setMeshVisibility=function(e,t=!1){e.metadata||(e.metadata={}),e.metadata[kt]?this._octreeManager.setMeshVisibility(e,t):t&&this.addMeshToScene(e)};J.prototype.makeStandardMaterial=function(e){var t=new hi(e,this.scene);return t.specularColor.copyFromFloats(0,0,0),t.ambientColor.copyFromFloats(1,1,1),t.diffuseColor.copyFromFloats(1,1,1),t};J.prototype.prepareChunkForRendering=function(e){};J.prototype.disposeChunkForRendering=function(e){};J.prototype._rebaseOrigin=function(e){var t=new ce(e[0],e[1],e[2]);this.scene.meshes.forEach(r=>{r.parent||(r.position.subtractInPlace(t),r.isWorldMatrixFrozen&&r.freezeWorldMatrix())}),this._octreeManager.rebase(t)};function Uu(e){var t=e.noa.camera,r=t._localGetTargetPosition();e._cameraHolder.position.copyFromFloats(r[0],r[1],r[2]),e._cameraHolder.rotation.x=t.pitch,e._cameraHolder.rotation.y=t.heading,e.camera.position.z=-t.currentZoom;var n=t._localGetPosition(),i=e.noa.worldOriginOffset,a=Math.floor(n[0]+i[0]),s=Math.floor(n[1]+i[1]),o=Math.floor(n[2]+i[2]),c=e.noa.getBlock(a,s,o);zu(e,c)}function zu(e,t){if(t!==e._camLocBlock){if(t===0)e._camScreen.setEnabled(!1);else{var r=e.noa.registry.getBlockFaceMaterial(t,0);if(r){var n=e.noa.registry.getMaterialData(r),i=n.color,a=n.alpha;i&&a&&a<1&&(e._camScreenMat.diffuseColor.set(0,0,0),e._camScreenMat.ambientColor.set(i[0],i[1],i[2]),e._camScreenMat.alpha=a,e._camScreen.setEnabled(!0))}}e._camLocBlock=t}}function qu(e){var t=e._highlightMesh;if(!t){t=Vr("highlight",{size:1},e.scene);var r=e.makeStandardMaterial("block_highlight_mat");r.backFaceCulling=!1,r.emissiveColor=new nt(1,1,1),r.alpha=.2,r.freeze(),t.material=r;var n=.5,i=fi("hightlightLines",{points:[new ce(n,n,0),new ce(n,-n,0),new ce(-n,-n,0),new ce(-n,n,0),new ce(n,n,0)]},e.scene);i.color=new nt(1,1,1),i.parent=t,e.addMeshToScene(t),e.addMeshToScene(i),e._highlightMesh=t}return t}J.prototype.debug_SceneCheck=function(){var e=this.scene.meshes,t=this.scene._selectionOctree,r=t.dynamicContent,n=[],i=0,a=0,s=this.scene.materials,o=[];s.forEach(d=>{d.subMaterials?d.subMaterials.forEach(l=>o.push(l)):o.push(d)}),t.blocks.forEach(function(d){i++,d.entries.forEach(l=>n.push(l))}),e.forEach(function(d){if(d.isDisposed()&&h(d,"disposed mesh in scene"),!m(d)){if(p(d,r,n)&&h(d,"non-empty mesh missing from octree"),!d.material){h(d,"non-empty scene mesh with no material");return}a+=d.subMeshes?d.subMeshes.length:1;var l=d.material.subMaterials||[d.material];l.forEach(function(v){p(v,l)&&h(v,"mesh material not in scene")})}});var c=[];o.forEach(d=>{var l=!1;e.forEach(v=>{if(v.material===d&&(l=!0),!!v.material){var f=v.material.subMaterials||[v.material];f.includes(d)&&(l=!0)}}),l||c.push(d.name)}),c.length&&console.warn("Materials unused by any mesh: ",c.join(", ")),r.forEach(function(d){p(d,e)&&h(d,"octree/dynamic mesh not in scene")}),n.forEach(function(d){p(d,e)&&h(d,"octree block mesh not in scene")});var u=Math.round(10*n.length/i)/10;console.log("meshes - octree:",n.length,"  dynamic:",r.length,"   subMeshes:",a,"   avg meshes/octreeBlock:",u);function h(d,l){console.warn(d.name+" --- "+l)}function m(d){return d.getIndices().length===0}function p(d,l,v){return!(!d||l.includes(d)||v&&v.includes(d))}return"done."};J.prototype.debug_MeshCount=function(){var e={};this.scene.meshes.forEach(r=>{var n=r.name||"";n=n.replace(/-\d+.*/,"#"),n=n.replace(/\d+.*/,"#"),n=n.replace(/(rotHolder|camHolder|camScreen)/,"rendering use"),n=n.replace(/atlas sprite .*/,"atlas sprites"),e[n]=e[n]||0,e[n]++});for(var t in e)console.log("   "+(e[t]+"       ").substr(0,7)+t)};var Nn=function(){};function $u(){var e=document.createElement("div");e.id="noa_fps",e.style.position="absolute",e.style.top="0",e.style.right="0",e.style.zIndex="0",e.style.color="white",e.style.backgroundColor="rgba(0,0,0,0.5)",e.style.font="14px monospace",e.style.textAlign="center",e.style.minWidth="2em",e.style.margin="4px",document.body.appendChild(e);var t=1e3,r=0,n=0,i=performance.now(),a=i;Nn=function(){r++;var s=performance.now();if(s-a>n&&(n=s-a),a=s,!(s-i<t)){var o=Math.round(r/(s-i)*1e3),c=Math.round(1/n*1e3);e.innerHTML=o+"<br>"+c,r=0,n=0,i=s}}}class Nu{constructor(t,r,n,i,a,s,o){this.aabb=new At(t.base,t.vec),this.mass=r,this.friction=n,this.restitution=i,this.gravityMultiplier=a,this.onCollide=s,this.autoStep=!!o,this.airDrag=-1,this.fluidDrag=-1,this.onStep=null,this.velocity=T.create(),this.resting=[0,0,0],this.inFluid=!1,this._ratioInFluid=0,this._forces=T.create(),this._impulses=T.create(),this._sleepFrameCount=10}setPosition(t){T.subtract(t,t,this.aabb.base),this.aabb.translate(t),this._markActive()}getPosition(){return T.clone(this.aabb.base)}applyForce(t){T.add(this._forces,this._forces,t),this._markActive()}applyImpulse(t){T.add(this._impulses,this._impulses,t),this._markActive()}_markActive(){this._sleepFrameCount=10}atRestX(){return this.resting[0]}atRestY(){return this.resting[1]}atRestZ(){return this.resting[2]}}function Vu(){this.airDrag=.1,this.fluidDrag=.4,this.fluidDensity=2,this.gravity=[0,-10,0],this.minBounceImpulse=.5}function St(e,t,r){e=Object.assign(new Vu,e),this.gravity=e.gravity||[0,-10,0],this.airDrag=e.airDrag||.1,this.fluidDensity=e.fluidDensity||2,this.fluidDrag=e.fluidDrag||.4,this.minBounceImpulse=e.minBounceImpulse,this.bodies=[],this.testSolid=t,this.testFluid=r}St.prototype.addBody=function(e,t,r,n,i,a){e=e||new At([0,0,0],[1,1,1]),typeof t>"u"&&(t=1),typeof r>"u"&&(r=1),typeof n>"u"&&(n=0),typeof i>"u"&&(i=1);var s=new Nu(e,t,r,n,i,a);return this.bodies.push(s),s};St.prototype.removeBody=function(e){var t=this.bodies.indexOf(e);t<0||(this.bodies.splice(t,1),e.aabb=e.onCollide=null)};var vt=T.create(),Fe=T.create(),Ht=T.create(),me=T.create(),Rr=T.create();St.prototype.tick=function(e){e=e/1e3;var t=Ft(0,T.squaredLength(this.gravity));this.bodies.forEach(r=>Hu(this,r,e,t))};function Hu(e,t,r,n){if(T.copy(Rr,t.resting),t.mass<=0){T.set(t.velocity,0,0,0),T.set(t._forces,0,0,0),T.set(t._impulses,0,0,0);return}var i=n||t.gravityMultiplier===0;if(!Yu(e,t,r,i)){t._sleepFrameCount--,Gu(e,t),pt(t._forces),pt(t._impulses),pt(t.velocity),pt(t.resting),T.scale(vt,t._forces,1/t.mass),T.scaleAndAdd(vt,vt,e.gravity,t.gravityMultiplier),T.scale(Fe,t._impulses,1/t.mass),T.scaleAndAdd(Fe,Fe,vt,r),T.add(t.velocity,t.velocity,Fe),t.friction&&(Gt(0,t,Fe),Gt(1,t,Fe),Gt(2,t,Fe));var a=t.airDrag>=0?t.airDrag:e.airDrag;t.inFluid&&(a=t.fluidDrag>=0?t.fluidDrag:e.fluidDrag,a*=1-(1-t.ratioInFluid)**2);var s=Math.max(1-a*r/t.mass,0);T.scale(t.velocity,t.velocity,s),T.scale(Ht,t.velocity,r),T.set(t._forces,0,0,0),T.set(t._impulses,0,0,0),t.autoStep&&Hn(Or,t.aabb),Vn(e,t.aabb,Ht,t.resting),t.autoStep&&Ku(e,t,Or,Ht);for(var o=0;o<3;++o)me[o]=0,t.resting[o]&&(Rr[o]||(me[o]=-t.velocity[o]),t.velocity[o]=0);var c=T.length(me);c>.001&&(T.scale(me,me,t.mass),t.onCollide&&t.onCollide(me),t.restitution>0&&c>e.minBounceImpulse&&(T.scale(me,me,t.restitution),t.applyImpulse(me)));var u=T.squaredLength(t.velocity);u>1e-5&&t._markActive()}}function Gu(e,t){var r=t.aabb,n=Math.floor(r.base[0]),i=Math.floor(r.base[2]),a=Math.floor(r.base[1]),s=Math.floor(r.max[1]);if(!e.testFluid(n,a,i)){t.inFluid=!1,t.ratioInFluid=0;return}for(var o=1,c=a+1;c<=s&&e.testFluid(n,c,i);)o++,c++;var u=a+o,h=u-r.base[1],m=h/r.vec[1];m>1&&(m=1);var p=r.vec[0]*r.vec[1]*r.vec[2],d=p*m,l=ju;T.scale(l,e.gravity,-e.fluidDensity*d),t.applyForce(l),t.inFluid=!0,t.ratioInFluid=m}var ju=T.create();function Gt(e,t,r){var n=t.resting[e],i=r[e];if(n!==0&&!(n*i<=0)){T.copy(jt,t.velocity),jt[e]=0;var a=T.length(jt);if(!Ft(a,0)){var s=Math.abs(t.friction*i),o=a>s?(a-s)/a:0;t.velocity[(e+1)%3]*=o,t.velocity[(e+2)%3]*=o}}}var jt=T.create();function Vn(e,t,r,n){return T.set(n,0,0,0),st(e.testSolid,t,r,function(i,a,s,o){n[a]=s,o[a]=0})}var Or=new At([],[]),Kt=T.create(),dt=T.create(),Dr=T.create(),Yt=T.create();function Ku(e,t,r,n){if(!(t.resting[1]>=0&&!t.inFluid)){var i=t.resting[0]!==0,a=t.resting[2]!==0;if(!!(i||a)){var s=Math.abs(n[0]/n[2]),o=4;if(!(!i&&s>o)&&!(!a&&s<1/o)){T.add(dt,r.base,n);var c=e.testSolid;st(c,r,n,function(p,d,l,v){if(d===1)v[d]=0;else return!0});var u=t.aabb.base[1],h=Math.floor(u+1.001)-u;T.set(Dr,0,h,0);var m=!1;st(c,r,Dr,function(p,d,l,v){return m=!0,!0}),!m&&(T.subtract(Yt,dt,r.base),Yt[1]=0,Vn(e,r,Yt,Kt),!(i&&!Ft(r.base[0],dt[0]))&&(a&&!Ft(r.base[2],dt[2])||(Hn(t.aabb,r),t.resting[0]=Kt[0],t.resting[2]=Kt[2],t.onStep&&t.onStep())))}}}}function Yu(e,t,r,n){if(t._sleepFrameCount>0)return!1;if(n)return!0;var i=!1,a=.5*r*r*t.gravityMultiplier;return T.scale(Br,e.gravity,a),st(e.testSolid,t.aabb,Br,function(){return i=!0,!0},!0),i}var Br=T.create();function Ft(e,t){return Math.abs(e-t)<1e-5}function Hn(e,t){for(var r=0;r<3;r++)e.base[r]=t.base[r],e.max[r]=t.max[r],e.vec[r]=t.vec[r]}var pt=function(e){},Wu={gravity:[0,-10,0],airDrag:.1};class Zu extends St{constructor(t,r){r=Object.assign({},Wu,r);var n=t.world,i=t.registry._solidityLookup,a=t.registry._fluidityLookup,s=t.worldOriginOffset,o=(u,h,m)=>{var p=n.getBlockID(u+s[0],h+s[1],m+s[2]);return i[p]},c=(u,h,m)=>{var p=n.getBlockID(u+s[0],h+s[1],m+s[2]);return a[p]};super(r,o,c)}}function he(e,t,r,n,i,a,s,o=-1){this.noa=e,this.isDisposed=!1,this.userData=null,this.requestID=t,this.voxels=s,this.i=r,this.j=n,this.k=i,this.size=a,this.x=r*a,this.y=n*a,this.z=i*a,this.pos=[this.x,this.y,this.z],this._terrainDirty=!1,this._objectsDirty=!1,this._terrainMeshes=[],e._terrainMesher.initChunk(this),e._objectMesher.initChunk(this),this._isFull=!1,this._isEmpty=!1,this._wholeLayerVoxel=Array(a).fill(-1),o>=0&&(this.voxels.data.fill(o,0,this.voxels.size),this._wholeLayerVoxel.fill(o));var c=Array.from(Array(27),()=>null);this._neighbors=at(c,[3,3,3]).lo(1,1,1),this._neighbors.set(0,0,0,this),this._neighborCount=0,this._timesMeshed=0,this._blockHandlerLocs=new ge,Gn(this)}he._createVoxelArray=function(e){var t=new Uint16Array(e*e*e);return at(t,[e,e,e])};he.prototype._updateVoxelArray=function(e,t=-1){jn(this,"onUnload"),this.noa._objectMesher.disposeChunk(this),this.noa._terrainMesher.disposeChunk(this),this.voxels=e,this._terrainDirty=!1,this._objectsDirty=!1,this._blockHandlerLocs.empty(),this.noa._objectMesher.initChunk(this),this.noa._terrainMesher.initChunk(this),t>=0?this._wholeLayerVoxel.fill(t):this._wholeLayerVoxel.fill(-1),Gn(this)};he.prototype.get=function(e,t,r){return this.voxels.get(e,t,r)};he.prototype.getSolidityAt=function(e,t,r){var n=this.noa.registry._solidityLookup;return n[this.voxels.get(e,t,r)]};he.prototype.set=function(e,t,r,n){var i=this.voxels.get(e,t,r);if(n!==i){this.voxels.set(e,t,r,n);var a=this.noa.registry._solidityLookup,s=this.noa.registry._objectLookup,o=this.noa.registry._opacityLookup,c=this.noa.registry._blockHandlerLookup;o[n]||(this._isFull=!1),n!==0&&(this._isEmpty=!1),this._wholeLayerVoxel[t]!==n&&(this._wholeLayerVoxel[t]=-1);var u=c[i],h=c[n];u&&Lt(this,u,"onUnset",e,t,r),h?(Lt(this,h,"onSet",e,t,r),this._blockHandlerLocs.add(e,t,r)):this._blockHandlerLocs.remove(e,t,r);var m=this.noa._objectMesher,p=s[i],d=s[n];p&&m.setObjectBlock(this,0,e,t,r),d&&m.setObjectBlock(this,n,e,t,r);var l=a[i]!==a[n],v=o[i]!==o[n],f=!p&&i!==0,y=!d&&n!==0;if((p||d)&&(this._objectsDirty=!0),(l||v||f||y)&&(this._terrainDirty=!0),(this._terrainDirty||this._objectsDirty)&&this.noa.world._queueChunkForRemesh(this),l||v){for(var g=this.size-1,k=e===0?-1:0,_=t===0?-1:0,M=r===0?-1:0,C=e===g?1:0,P=t===g?1:0,E=r===g?1:0,L=k;L<=C;L++)for(var w=_;w<=P;w++)for(var F=M;F<=E;F++)if((L|w|F)!==0){var x=this._neighbors.get(L,w,F);!x||(x._terrainDirty=!0,this.noa.world._queueChunkForRemesh(x))}}}};function Lt(e,t,r,n,i,a){var s=t[r];!s||s(e.x+n,e.y+i,e.z+a)}he.prototype.updateMeshes=function(){this._terrainDirty&&(this.noa._terrainMesher.meshChunk(this),this._timesMeshed++,this._terrainDirty=!1),this._objectsDirty&&(this.noa._objectMesher.buildObjectMeshes(),this._objectsDirty=!1)};function Gn(e){for(var t=e.voxels,r=t.data,n=t.shape[0],i=e.noa.registry._opacityLookup,a=e.noa.registry._blockHandlerLookup,s=e.noa.registry._objectLookup,o=e.noa.registry._blockIsPlainLookup,c=e.noa._objectMesher,u=!0,h=!0,m=0;m<n;++m){var p=e._wholeLayerVoxel[m];if(p>=0&&!c[p]&&!a[p]){i[p]||(u=!1),p!==0&&(h=!1);continue}for(var d=t.get(0,m,0),l=0;l<n;++l)for(var v=t.index(l,m,0),f=0;f<n;++f,++v){var y=r[v];if(d>=0&&y!==d&&(d=-1),y===0){u=!1;continue}if(o[y]){h=!1;continue}u=u&&i[y],h=!1,s[y]&&(c.setObjectBlock(e,y,l,m,f),e._objectsDirty=!0);var g=a[y];g&&(e._blockHandlerLocs.add(l,m,f),Lt(e,g,"onLoad",l,m,f))}d>=0&&(e._wholeLayerVoxel[m]=d)}e._isFull=u,e._isEmpty=h,e._terrainDirty=!e._isEmpty}he.prototype.dispose=function(){jn(this,"onUnload"),this._blockHandlerLocs.empty(),this.noa._objectMesher.disposeChunk(this),this.noa._terrainMesher.disposeChunk(this),this.voxels.data=null,this.voxels=null,this._neighbors.data=null,this._neighbors=null,this.isDisposed=!0};function jn(e,t){var r=e.voxels,n=e.noa.registry._blockHandlerLookup;e._blockHandlerLocs.arr.forEach(([i,a,s])=>{var o=r.get(i,a,s);Lt(e,n[o],t,i,a,s)})}var Xu=0,Qu=0,Ju={chunkSize:24,chunkAddDistance:[2,2],chunkRemoveDistance:[3,3],worldGenWhilePaused:!1,manuallyControlChunkLoading:!1};class H extends Ie.exports{constructor(t,r){super(),r=Object.assign({},Ju,r),this.noa=t,this.playerChunkLoaded=!1,this.Chunk=he,this.manuallyControlChunkLoading=!!r.manuallyControlChunkLoading,this.chunkSortingDistFn=fr,this.minNeighborsToMesh=6,this.worldGenWhilePaused=!!r.worldGenWhilePaused,this.maxChunksPendingCreation=50,this.maxChunksPendingMeshing=50,this.maxProcessingPerTick=5,this.maxProcessingPerRender=3,this._chunkSize=r.chunkSize,this._chunkAddDistance=[2,2],this._chunkRemoveDistance=[3,3],this._addDistanceFn=null,this._remDistanceFn=null,this._prevWorldName="",this._prevPlayerChunkHash=0,this._chunkAddSearchFrom=0,this._prevSortingFn=null,this._sortMeshQueueEvery=0,this._chunksKnown=new ge,this._chunksToRequest=new ge,this._chunksInvalidated=new ge,this._chunksToRemove=new ge,this._chunksPending=new ge,this._chunksToMesh=new ge,this._chunksToMeshFirst=new ge,this._chunksSortedLocs=new ge,this.setAddRemoveDistance(r.chunkAddDistance,r.chunkRemoveDistance),this._storage=new vu;var n=this._chunkSize;this._coordsToChunkIndexes=lc,this._coordsToChunkLocals=hc;var i=(n&n-1)===0;i&&(this._coordShiftBits=Math.log2(n)|0,this._coordMask=n-1|0,this._coordsToChunkIndexes=fc,this._coordsToChunkLocals=vc)}}H.prototype.getBlockID=function(e=0,t=0,r=0){var[n,i,a]=this._coordsToChunkIndexes(e,t,r),s=this._storage.getChunkByIndexes(n,i,a);if(!s)return 0;var[o,c,u]=this._coordsToChunkLocals(e,t,r);return s.voxels.get(o,c,u)};H.prototype.getBlockSolidity=function(e=0,t=0,r=0){var[n,i,a]=this._coordsToChunkIndexes(e,t,r),s=this._storage.getChunkByIndexes(n,i,a);if(!s)return!1;var[o,c,u]=this._coordsToChunkLocals(e,t,r);return!!s.getSolidityAt(o,c,u)};H.prototype.getBlockOpacity=function(e=0,t=0,r=0){var n=this.getBlockID(e,t,r);return this.noa.registry.getBlockOpacity(n)};H.prototype.getBlockFluidity=function(e=0,t=0,r=0){var n=this.getBlockID(e,t,r);return this.noa.registry.getBlockFluidity(n)};H.prototype.getBlockProperties=function(e=0,t=0,r=0){var n=this.getBlockID(e,t,r);return this.noa.registry.getBlockProps(n)};H.prototype.setBlockID=function(e=0,t=0,r=0,n=0){var[i,a,s]=this._coordsToChunkIndexes(t,r,n),o=this._storage.getChunkByIndexes(i,a,s);if(!!o){var[c,u,h]=this._coordsToChunkLocals(t,r,n);return o.set(c,u,h,e)}};H.prototype.isBoxUnobstructed=function(e){for(var t=e.base,r=e.max,n=Math.floor(t[0]);n<r[0]+1;n++)for(var i=Math.floor(t[1]);i<r[1]+1;i++)for(var a=Math.floor(t[2]);a<r[2]+1;a++)if(this.getBlockSolidity(n,i,a))return!1;return!0};H.prototype.setChunkData=function(e,t,r=null,n=-1){oc(this,e,t,r,n)};H.prototype.setAddRemoveDistance=function(e=2,t=3){var r=Array.isArray(e)?e:[e,e],n=Array.isArray(t)?t:[t,t],i=1;n[0]<r[0]+i&&(n[0]=r[0]+i),n[1]<r[1]+i&&(n[1]=r[1]+i),this._chunkAddDistance=r,this._chunkRemoveDistance=n,this._addDistanceFn=qr(r[0],r[1]),this._remDistanceFn=qr(n[0],n[1]),this._chunksSortedLocs.empty();for(var a=0;a<=r[0];a++)for(var s=0;s<=a;s++)for(var o=0;o<=r[1];o++)!this._addDistanceFn(a,o,s)||this._chunksSortedLocs.add(a,o,s);this._prevSortingFn=null,this._chunkAddSearchFrom=0};H.prototype.invalidateVoxelsInAABB=function(e){nc(this,e)};H.prototype.manuallyLoadChunk=function(e=0,t=0,r=0){if(!this.manuallyControlChunkLoading)throw Kn;var[n,i,a]=this._coordsToChunkIndexes(e,t,r);this._chunksKnown.add(n,i,a),this._chunksToRequest.add(n,i,a)};H.prototype.manuallyUnloadChunk=function(e=0,t=0,r=0){if(!this.manuallyControlChunkLoading)throw Kn;var[n,i,a]=this._coordsToChunkIndexes(e,t,r);this._chunksToRemove.add(n,i,a),this._chunksToMesh.remove(n,i,a),this._chunksToRequest.remove(n,i,a),this._chunksToMeshFirst.remove(n,i,a)};var Kn="Set `noa.world.manuallyControlChunkLoading` if you need this API";H.prototype.tick=function(){var e=performance.now(),[t,r,n]=Yn(this),i=le(t,r,n),a=i!==this._prevPlayerChunkHash;a&&(this.emit("playerEnteredChunk",t,r,n),this._prevPlayerChunkHash=i,this._chunkAddSearchFrom=0),this._prevWorldName!==this.noa.worldName&&(this.manuallyControlChunkLoading||(ic(this),this._chunkAddSearchFrom=0,Zt(this)),this._prevWorldName=this.noa.worldName),Pe("start"),je("start"),this.manuallyControlChunkLoading||(tc(this,t,r,n),Pe("remQueue"),ec(this,t,r,n),Pe("addQueue")),rc(this);var s=performance.now(),o=e+(this.maxProcessingPerTick||0);s<o&&(o=s+1);for(var c=!1,u=!1,h=!1;s<o&&(c||(c=Zt(this)||Zt(this),Pe("removes")),u||(u=ac(this),Pe("requests")),h||(h=Wn(this,!1),Pe("meshes")),!(c&&u&&h));)s=performance.now();var m=this._storage.getChunkByIndexes(t,r,n);this.playerChunkLoaded=!!m,je("end",this),Pe("end")};H.prototype.render=function(){for(var e=performance.now(),t=e+this.maxProcessingPerRender;e<t;){var r=Wn(this,!0);if(r)break;e=performance.now()}};H.prototype._getChunkByCoords=function(e=0,t=0,r=0){var[n,i,a]=this._coordsToChunkIndexes(e,t,r);return this._storage.getChunkByIndexes(n,i,a)};H.prototype._queueChunkForRemesh=function(e){Rt(this,e)};function Yn(e){var[t,r,n]=e.noa.entities.getPosition(e.noa.playerEntity);return e._coordsToChunkIndexes(t,r,n)}function ec(e,t,r,n){var i=e._chunksToRequest,a=i.count(),s=50;if(!(a>=s)){var o=e.chunkSortingDistFn||fr;o!==e._prevSortingFn&&(ut(e,e._chunksSortedLocs,0,0,0,!0),e._prevSortingFn=o);for(var c=e._chunksSortedLocs.arr,u=e._chunkAddSearchFrom,h=Math.min(20,c.length/10),m=0;m<h;m++){var[p,d,l]=c[u++%c.length];if(Mt(e,t,r,n,p,d,l),i.count()>=s)break}e._chunksInvalidated.isEmpty()&&(e._chunkAddSearchFrom=u%c.length),ut(e,i,t,r,n,!1)}}var Mt=(e,t,r,n,i,a,s)=>{Ur(e,t+i,r+a,n+s),i!==s&&Ur(e,t+s,r+a,n+i),i>0&&Mt(e,t,r,n,-i,a,s),a>0&&Mt(e,t,r,n,i,-a,s),s>0&&Mt(e,t,r,n,i,a,-s)},Ur=(e,t,r,n)=>{e._chunksKnown.includes(t,r,n)||(e._chunksKnown.add(t,r,n),e._chunksToRequest.add(t,r,n,!0))};function tc(e,t,r,n){var i=e._remDistanceFn,a=e._chunksToRemove,s=a.count()+e._chunksInvalidated.count(),o=50;if(!(s>=o)){var c=e._chunksKnown.arr;if(c.length!==0){for(var u=Math.min(100,c.length/10),h=!1,m=0;m<u;m++){var[p,d,l]=c[Wt++%c.length];if(!a.includes(p,d,l)&&!i(p-t,d-r,l-n)&&(e._chunksToRemove.add(p,d,l),e._chunksToRequest.remove(p,d,l),e._chunksToMesh.remove(p,d,l),e._chunksToMeshFirst.remove(p,d,l),h=!0,s++,s>o))break}Wt=Wt%c.length,h&&ut(e,a,t,r,n)}}}var Wt=0;function rc(e){var t=10,r=e._chunksToMesh.count()+e._chunksToMeshFirst.count();if(!(r>t)){for(var n=e._chunksKnown.arr,i=Math.min(50,n.length/10),a=0;a<i;a++){var[s,o,c]=n[zr++%n.length],u=e._storage.getChunkByIndexes(s,o,c);if(!!u){var h=Rt(e,u);if(h&&r++,r>t)break}}zr%=n.length}}var zr=0;function nc(e,t){for(var r=e._coordsToChunkIndexes(t.base[0],t.base[1],t.base[2]),n=e._coordsToChunkIndexes(t.max[0],t.max[1],t.max[2]),i=0;i<3;i++)Number.isFinite(t.base[i])||(r[i]=t.base[i]),Number.isFinite(t.max[i])||(n[i]=t.max[i]);e._chunksKnown.forEach(a=>{var[s,o,c]=a;s<r[0]||s>=n[0]||o<r[1]||o>=n[1]||c<r[2]||c>=n[2]||(e._chunksInvalidated.add(s,o,c),e._chunksToRemove.remove(s,o,c),e._chunksToRequest.remove(s,o,c),e._chunksToMesh.remove(s,o,c),e._chunksToMeshFirst.remove(s,o,c))})}function ic(e){e._chunksInvalidated.copyFrom(e._chunksKnown),e._chunksToRemove.empty(),e._chunksToRequest.empty(),e._chunksToMesh.empty(),e._chunksToMeshFirst.empty(),ut(e,e._chunksInvalidated)}function ac(e){var t=e._chunksToRequest;if(t.isEmpty())return!0;var r=e._chunksPending.count(),n=e._chunksToMesh.count();if(r>=e.maxChunksPendingCreation||n>=e.maxChunksPendingMeshing)return!0;var[i,a,s]=t.pop();return sc(e,i,a,s),t.isEmpty()}function Zt(e){var t=e._chunksInvalidated;if(t.isEmpty()&&(t=e._chunksToRemove),t.isEmpty())return!0;var[r,n,i]=t.pop();return uc(e,r,n,i),t.isEmpty()}function Wn(e,t){var r=e._chunksToMeshFirst;if(r.isEmpty()&&!t&&(r=e._chunksToMesh),r.isEmpty())return!0;var[n,i,a]=r.pop();if(!e._chunksToRemove.includes(n,i,a)){var s=e._storage.getChunkByIndexes(n,i,a);s&&cc(e,s)}}function Rt(e,t){if(!(t._terrainDirty||t._objectsDirty)||t._neighborCount<t.minNeighborsToMesh||e._chunksToMesh.includes(t.i,t.j,t.k)||e._chunksToMeshFirst.includes(t.i,t.j,t.k))return!1;var r=t._neighborCount===26?e._chunksToMeshFirst:e._chunksToMesh;return r.add(t.i,t.j,t.k),e._sortMeshQueueEvery++,e._sortMeshQueueEvery>20&&(ut(e,r),e._sortMeshQueueEvery=0),!0}function sc(e,t,r,n){var i=e._chunkSize,a=he._createVoxelArray(e._chunkSize),s=e.noa.worldName,o=[t,r,n,s].join("|"),c=t*i,u=r*i,h=n*i;e._chunksPending.add(t,r,n),e.emit("worldDataNeeded",o,a,c,u,h,s),je("request")}function oc(e,t,r,n,i){var a=t.split("|"),s=parseInt(a.shift()),o=parseInt(a.shift()),c=parseInt(a.shift()),u=a.join("|");if(e._chunksPending.remove(s,o,c),u===e.noa.worldName&&!!e._chunksKnown.includes(s,o,c)&&!e._chunksToRemove.includes(s,o,c)){var h=e._storage.getChunkByIndexes(s,o,c);if(h)h._updateVoxelArray(r,i);else{var m=e._chunkSize;h=new he(e.noa,t,s,o,c,m,r,i),e._storage.storeChunkByIndexes(s,o,c,h),h.userData=n,e.noa.rendering.prepareChunkForRendering(h),e.emit("chunkAdded",h)}Rt(e,h),Zn(e,s,o,c,h),je("receive")}}function uc(e,t,r,n){var i=e._storage.getChunkByIndexes(t,r,n);i&&(e.emit("chunkBeingRemoved",i.requestID,i.voxels,i.userData),e.noa.rendering.disposeChunkForRendering(i),i.dispose(),je("dispose"),Zn(e,t,r,n,null)),e._storage.removeChunkByIndexes(t,r,n),e._chunksKnown.remove(t,r,n),e._chunksToMesh.remove(t,r,n),e._chunksToRemove.remove(t,r,n),e._chunksToMeshFirst.remove(t,r,n)}function cc(e,t){e._chunksToMesh.remove(t.i,t.j,t.k),e._chunksToMeshFirst.remove(t.i,t.j,t.k),t.updateMeshes(),je("mesh")}function lc(e,t,r){var n=this._chunkSize;return[Math.floor(e/n)|0,Math.floor(t/n)|0,Math.floor(r/n)|0]}function hc(e,t,r){var n=this._chunkSize,i=e%n|0;i<0&&(i+=n);var a=t%n|0;a<0&&(a+=n);var s=r%n|0;return s<0&&(s+=n),[i,a,s]}function fc(e,t,r){var n=this._coordShiftBits;return[e>>n|0,t>>n|0,r>>n|0]}function vc(e,t,r){var n=this._coordMask;return[e&n|0,t&n|0,r&n|0]}function ut(e,t,r,n,i,a=!1){var s=e.chunkSortingDistFn||fr,o=(c,u,h)=>s(r-c,n-u,i-h);r===void 0&&([r,n,i]=Yn(e)),t.sortByDistance(o,a)}var fr=(e,t,r)=>e*e+t*t+r*r;function Zn(e,t,r,n,i){for(var a=!i||i&&!i.isEmpty,s=-1;s<=1;s++)for(var o=-1;o<=1;o++)for(var c=-1;c<=1;c++)if((s|o|c)!==0){var u=e._storage.getChunkByIndexes(t+s,r+o,n+c);if(!!u){a&&(u._terrainDirty=!0),i&&!i._neighbors.get(s,o,c)&&(i._neighborCount++,i._neighbors.set(s,o,c,u));var h=u._neighbors.get(-s,-o,-c);i&&!h&&(u._neighborCount++,u._neighbors.set(-s,-o,-c,i),u._neighborCount===26&&Rt(e,u)),!i&&h&&(u._neighborCount--,u._neighbors.set(-s,-o,-c,null))}}}function qr(e,t){var r=e*e,n=t*t;return e===t?(i,a,s)=>i*i+a*a+s*s<=r:e>t?(i,a,s)=>Math.abs(a)>t?!1:i*i+a*a+s*s<=r:(i,a,s)=>{var o=i*i+s*s;return o>r?!1:o+a*a<=n}}H.prototype.report=function(){console.log("World report - playerChunkLoaded: ",this.playerChunkLoaded),Le(this,"  known:     ",this._chunksKnown.arr,!0),Le(this,"  to request:",this._chunksToRequest.arr,0),Le(this,"  to remove: ",this._chunksToRemove.arr,0),Le(this,"  invalid:   ",this._chunksInvalidated.arr,0),Le(this,"  creating:  ",this._chunksPending.arr,0),Le(this,"  to mesh:   ",this._chunksToMesh.arr,0),Le(this,"  mesh 1st:  ",this._chunksToMeshFirst.arr,0)};function Le(e,t,r,n){var i=0,a=0,s=0,o=0,c=[];r.forEach(d=>{var l=e._storage.getChunkByIndexes(d[0],d[1],d[2]);!l||(s++,c.push(l._timesMeshed),l._isFull&&i++,l._isEmpty&&a++,l._neighborCount===26&&o++)});var u=r.length.toString().padEnd(8);if(u+=("exist: "+s).padEnd(12),u+=("full: "+i).padEnd(12),u+=("empty: "+a).padEnd(12),u+=("surr: "+o).padEnd(12),n){var h=c.reduce((d,l)=>d+l,0),m=c.reduce((d,l)=>Math.max(d,l),0),p=c.reduce((d,l)=>Math.min(d,l),0);u+="times meshed: avg "+(h/s).toFixed(2),u+="  max "+m,u+="  min "+p}console.log(t,u)}var Pe=pu(Xu,"world ticks:",1),je=(e=>{if(!(e>0))return()=>{};var t=0,r={},n={},i=performance.now();return function(s,o){if(s!=="start"){if(s!=="end")return r[s]=(r[s]||0)+1;if(n.toreq=(n.toreq||0)+o._chunksToRequest.count(),n.toget=(n.toget||0)+o._chunksPending.count(),n.tomesh=(n.tomesh||0)+o._chunksToMesh.count()+o._chunksToMeshFirst.count(),n.tomesh1=(n.tomesh1||0)+o._chunksToMeshFirst.count(),n.torem=(n.torem||0)+o._chunksToRemove.count(),!(++t<e)){var c=performance.now(),u=c-i,h={};Object.keys(n).forEach(m=>{var p=Math.round((n[m]||0)/t);h[m]=`[${p}]`.padStart(5)}),Object.keys(r).forEach(m=>{var p=Math.round((r[m]||0)*1e3/u);h[m]=(""+p).padStart(3)}),console.log("chunk flow: ",`${h.toreq}-> ${h.request||0} req/s  `,`${h.toget}-> ${h.receive||0} got/s  `,`${h.tomesh}-> ${h.mesh||0} mesh/s  `,`${h.torem}-> ${h.dispose||0} rem/s  `,`(meshFirst: ${h.tomesh1.trim()})`),t=0,r={},n={},i=performance.now()}}}})(Qu);const dc="noa-engine",pc="0.33.0",mc="Experimental voxel game engine",gc="src/index.js",yc="dist/src/index.d.ts",_c=["/src","/dist"],kc={build:"npm run types; npm run docs",types:"tsc",docs:"typedoc"},Mc="Andy Hall (https://fenomas.com)",Cc="MIT",wc={type:"git",url:"https://github.com/fenomas/noa.git"},Tc={url:"https://github.com/fenomas/noa/issues"},Ec={"aabb-3d":"fenomas/aabb-3d","box-intersect":"fenomas/box-intersect","ent-comp":"^0.11.0",events:"^3.3.0","fast-voxel-raycast":"^0.1.1","game-inputs":"^0.8.0","gl-vec3":"^1.1.3","micro-game-shell":"^0.9.0",ndarray:"^1.0.19","voxel-aabb-sweep":"^0.5.0","voxel-physics-engine":"^0.13.0"},Fc={"@babylonjs/core":"^6.1.0"},Lc={eslint:"^8.3.0","js-beautify":"^1.14.0",typedoc:"^0.24.6","typedoc-plugin-missing-exports":"^2.0.0",typescript:"^5.0.4"},Pc=["voxel","voxels","game","engine","game-engine"],bc={name:dc,version:pc,description:mc,main:gc,typings:yc,files:_c,scripts:kc,author:Mc,license:Cc,repository:wc,bugs:Tc,dependencies:Ec,peerDependencies:Fc,devDependencies:Lc,keywords:Pc};var Ac=bc.version,xc={debug:!1,silent:!1,silentBabylon:!1,playerHeight:1.8,playerWidth:.6,playerStart:[0,10,0],playerAutoStep:!1,playerShadowComponent:!0,tickRate:30,maxRenderRate:0,blockTestDistance:10,stickyPointerLock:!0,dragCameraOutsidePointerLock:!0,stickyFullscreen:!1,skipDefaultHighlighting:!1,originRebaseDistance:25};class Bc extends Ie.exports.EventEmitter{constructor(t={}){if(super(),t=Object.assign({},xc,t),this.version=Ac,!t.silent){var r=t.debug?" (debug)":"";console.log(`noa-engine v${this.version}${r}`)}this._paused=!1,this._originRebaseDistance=t.originRebaseDistance,this.worldOriginOffset=[0,0,0],this.positionInCurrentTick=0,this.worldName="default",this.timeScale=1,this.container=new Cs(this,t),this.tickRate=this.container._shell.tickRate,Object.defineProperty(this,"tickRate",{get:()=>this.container._shell.tickRate}),this.maxRenderRate=this.container._shell.maxRenderRate,Object.defineProperty(this,"maxRenderRate",{get:()=>this.container._shell.maxRenderRate,set:o=>{this.container._shell.maxRenderRate=o||0}}),this.inputs=new ds(this,t,this.container.element),this.registry=new xu(this,t),this.world=new H(this,t);var n=console.log;t.silentBabylon&&(console.log=()=>{}),this.rendering=new J(this,t,this.container.canvas),t.silentBabylon&&(console.log=n),this.physics=new Zu(this,t),this.entities=new fu(this,t),this.ents=this.entities;var i=this.entities;this.playerEntity=i.add(t.playerStart,t.playerWidth,t.playerHeight,null,null,!0,t.playerShadowComponent),i.addComponent(this.playerEntity,i.names.collideTerrain),i.addComponent(this.playerEntity,i.names.collideEntities);var a=i.getPhysics(this.playerEntity).body;if(a.gravityMultiplier=2,a.autoStep=t.playerAutoStep,i.addComponent(this.playerEntity,i.names.receivesInputs),i.addComponent(this.playerEntity,i.names.fadeOnZoom),i.addComponent(this.playerEntity,i.names.movement,{airJumps:1}),this.camera=new Hs(this,t),this.blockTestDistance=t.blockTestDistance,this.blockTargetIdCheck=this.registry.getBlockSolidity,this.targetedBlock=null,t.skipDefaultHighlighting||(this.defaultBlockHighlightFunction=o=>{o?this.rendering.highlightBlockFace(!0,o.position,o.normal):this.rendering.highlightBlockFace(!1)},this.on("targetBlockChanged",this.defaultBlockHighlightFunction)),this._terrainMesher=new Tu(this),this._objectMesher=new mu(this),this._targetedBlockDat={blockID:0,position:T.create(),normal:T.create(),adjacent:T.create()},this._prevTargetHash=0,this._pickPos=T.create(),this._pickResult={_localPosition:T.create(),position:[0,0,0],normal:[0,0,0]},t.debug){this.vec3=T,this.ndarray=at,i.getMovement(1).airJumps=999;var s=window;s.noa=this,s.vec3=T,s.ndarray=at,s.scene=this.rendering.scene}Rc(this)}tick(t){if(t*=this.timeScale||1,this._paused){this.world.worldGenWhilePaused&&this.world.tick();return}if(Ic(this),this.world.tick(),!this.world.playerChunkLoaded){this.rendering.tick(t);return}this.physics.tick(t),this._objectMesher.tick(),this.rendering.tick(t),Sc(this),this.entities.tick(t),this.emit("tick",t);var r=this.inputs.pointerState;r.scrollx=r.scrolly=r.scrollz=0}render(t,r){if(t*=this.timeScale||1,this.positionInCurrentTick=r,this._paused){this.world.worldGenWhilePaused&&this.world.render();return}this.camera.applyInputsToCamera(),this.world.render(),this.camera.updateBeforeEntityRenderSystems(),this.entities.render(t),this.camera.updateAfterEntityRenderSystems(),this.emit("beforeRender",t),this.rendering.render(),this.rendering.postRender(),this.emit("afterRender",t),this.inputs.pointerState.dx=this.inputs.pointerState.dy=0}setPaused(t=!1){this._paused=!!t,t||(this.inputs.pointerState.dx=this.inputs.pointerState.dy=0)}getBlock(t,r=0,n=0){return t.length?this.world.getBlockID(t[0],t[1],t[2]):this.world.getBlockID(t,r,n)}setBlock(t,r,n=0,i=0){return r.length?this.world.setBlockID(t,r[0],r[1],r[2]):this.world.setBlockID(t,r,n,i)}addBlock(t,r,n=0,i=0){return r.length?this.entities.isTerrainBlocked(r[0],r[1],r[2])?void 0:(this.world.setBlockID(t,r[0],r[1],r[2]),t):this.entities.isTerrainBlocked(r,n,i)?void 0:(this.world.setBlockID(t,r,n,i),t)}globalToLocal(t,r,n){var i=this.worldOriginOffset;if(r){for(var a=0;a<3;a++){var s=t[a]-i[a];s+=r[a],n[a]=s}return n}else return T.subtract(n,t,i)}localToGlobal(t,r,n=null){var i=this.worldOriginOffset;if(n){for(var a=0;a<3;a++){var s=Math.floor(t[a]);r[a]=s+i[a],n[a]=t[a]-s}return r}else return T.add(r,t,i)}pick(t=null,r=null,n=-1,i=null){if(n===0)return null;var a=this._pickPos;return t&&(this.globalToLocal(t,null,a),t=a),this._localPick(t,r,n,i)}_localPick(t=null,r=null,n=-1,i=null){if(n===0)return null;var a=i||this.registry.getBlockSolidity,s=this.world,o=this.worldOriginOffset,c=function(d,l,v){var f=s.getBlockID(d+o[0],l+o[1],v+o[2]);return a(f)};t||(t=this.camera._localGetTargetPosition()),r=r||this.camera.getDirection(),n=n||-1,n<0&&(n=this.blockTestDistance);var u=this._pickResult,h=u._localPosition,m=u.normal,p=Va(c,t,r,n,h,m);return p?(T.scaleAndAdd(h,h,m,.01),this.localToGlobal(h,u.position),u):null}}function Ic(e){var t=e.ents.getPositionData(e.playerEntity)._localPosition,r=e._originRebaseDistance;if(!(T.sqrLen(t)<r*r)){for(var n=[],i=0;i<3;i++)n[i]=Math.floor(t[i]),e.worldOriginOffset[i]+=n[i];e.rendering._rebaseOrigin(n),e.entities._rebaseOrigin(n),e._objectMesher._rebaseOrigin(n)}}function Sc(e){var t=0,r=e.blockTargetIdCheck||e.registry.getBlockSolidity,n=e._localPick(null,null,null,r);if(n){var i=e._targetedBlockDat;T.floor(i.adjacent,n.position),T.copy(i.normal,n.normal),T.subtract(i.position,i.adjacent,i.normal),i.blockID=e.world.getBlockID(i.position[0],i.position[1],i.position[2]),e.targetedBlock=i;var a=i.position,s=i.normal,o=le(a[0]+i.blockID,a[1],a[2]);o^=le(s[0],s[1]+i.blockID,s[2]),t=o}else e.targetedBlock=null;t!=e._prevTargetHash&&(e.emit("targetBlockChanged",e.targetedBlock),e._prevTargetHash=t)}function Rc(e){var t="0.27",r=(n,i,a)=>{var s=()=>{throw`This property changed in ${t} - ${a}`};Object.defineProperty(n,i,{get:s,set:s})};r(e,"getPlayerEyePosition","to get the camera/player offset see API docs for `noa.camera.cameraTarget`"),r(e,"setPlayerEyePosition","to set the camera/player offset see API docs for `noa.camera.cameraTarget`"),r(e,"getPlayerPosition","use `noa.ents.getPosition(noa.playerEntity)` or similar"),r(e,"getCameraVector","use `noa.camera.getDirection`"),r(e,"getPlayerMesh","use `noa.ents.getMeshData(noa.playerEntity).mesh` or similar"),r(e,"playerBody","use `noa.ents.getPhysicsBody(noa.playerEntity)`"),r(e.rendering,"zoomDistance","use `noa.camera.zoomDistance`"),r(e.rendering,"_currentZoom","use `noa.camera.currentZoom`"),r(e.rendering,"_cameraZoomSpeed","use `noa.camera.zoomSpeed`"),r(e.rendering,"getCameraVector","use `noa.camera.getDirection`"),r(e.rendering,"getCameraPosition","use `noa.camera.getLocalPosition`"),r(e.rendering,"getCameraRotation","use `noa.camera.heading` and `noa.camera.pitch`"),r(e.rendering,"setCameraRotation","to customize camera behavior see API docs for `noa.camera`"),t="0.28",r(e.rendering,"makeMeshInstance","removed, use Babylon's `mesh.createInstance`"),r(e.world,"_maxChunksPendingCreation",'use `maxChunksPendingCreation` (no "_")'),r(e.world,"_maxChunksPendingMeshing",'use `maxChunksPendingMeshing` (no "_")'),r(e.world,"_maxProcessingPerTick",'use `maxProcessingPerTick` (no "_")'),r(e.world,"_maxProcessingPerRender",'use `maxProcessingPerRender` (no "_")'),t="0.29",r(e,"_constants","removed, voxel IDs are no longer packed with bit flags"),t="0.30",r(e,"_tickRate","tickRate is now at `noa.tickRate`"),r(e.container,"_tickRate","tickRate is now at `noa.tickRate`"),t="0.31",r(e.world,"chunkSize","effectively an internal, so changed to `_chunkSize`"),r(e.world,"chunkAddDistance","set this with `noa.world.setAddRemoveDistance`"),r(e.world,"chunkRemoveDistance","set this with `noa.world.setAddRemoveDistance`"),t="0.33",r(e.rendering,"postMaterialCreationHook","Removed - use mesh post-creation hook instead`")}export{Bc as E};
